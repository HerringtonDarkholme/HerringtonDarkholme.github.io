<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Abitrarily Idiosyncratic Randomness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="あくまでも紳士です">
<meta property="og:type" content="website">
<meta property="og:title" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:url" content="http://herringtondarkholme.github.io/index.html">
<meta property="og:site_name" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:description" content="あくまでも紳士です">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Abitrarily Idiosyncratic Randomness">
<meta name="twitter:description" content="あくまでも紳士です">
  
    <link rel="alternative" href="/atom.xml" title="Abitrarily Idiosyncratic Randomness" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Abitrarily Idiosyncratic Randomness</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Hchan&#39;s Note</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://herringtondarkholme.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-js-tracker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/17/js-tracker/" class="article-date">
  <time datetime="2015-11-16T16:00:00.000Z" itemprop="datePublished">2015-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/17/js-tracker/">JavaScript Error tracking in browsers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Error tracking is one of the awful part of JavaScript. Server side error tracking requires several configuration, which is not hard because server is under developers’ full control, after all. For Android/iOS applications, error tracking is integrated into integrated into platform framework. Unfortunately, error tracking in browser is like survival in wild jungle.</p>
<p>Here are some common pitfalls.</p>
<h1 id="Incompatible_API">Incompatible API</h1><p>JavaScript errors in different browsers have different field names, as usual.</p>
<p>One should never bother to care about api incompatibility among browsers. Here is the snippet to normalize those quirks.<br>Curse the variable <code>ieEvent</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">errorTracker</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ieEvent</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> err !== <span class="string">'object'</span>) &#123;</span><br><span class="line">    ieEvent = &#123;&#125;</span><br><span class="line">    err = <span class="built_in">window</span>.event</span><br><span class="line">    ieEvent.message = err.errorMessage</span><br><span class="line">    ieEvent.filename = err.errorUrl</span><br><span class="line">    ieEvent.lineno = err.errorLine</span><br><span class="line">    err = ieEvent</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    message: err.message,</span><br><span class="line">    line: err.lineno || err.lineNumber,</span><br><span class="line">    file: err.filename || err.fileName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CORS_Header">CORS Header</h1><p>You will see a lot of <code>Scritp error</code> message in your CDN hosted javascript file. Browsers report this useless error intentially. Revealing error details to web page in different domain is a security issue. It can leak one’s privacy and helps phishing and social engineering. To quote the <a href="http://stackoverflow.com/questions/5913978/cryptic-script-error-reported-in-javascript-in-chrome-and-firefox" target="_blank" rel="external">SO answer</a></p>
<blockquote>
<p>This behavior is intentional, to prevent scripts from leaking information to external domains. For an example of why this is necessary, imagine accidentally visiting evilsite.com, that serves up a page with <code>&lt;script src=&quot;yourbank.com/index.html&quot;&gt;</code>. (yes, we’re pointing that script tag at html, not JS). This will result in a script error, but the error is interesting because it can tell us if you’re logged in or not. If you’re logged in, the error might be <code>&#39;Welcome Fred...&#39;</code> is undefined, whereas if you’re not it might be <code>&#39;Please Login ...&#39;</code> is undefined. Something along those lines.</p>
</blockquote>
<p>And in Chromium’s <a href="https://chromium.googlesource.com/chromium/src.git/+/master/third_party/WebKit/Source/core/dom/ExecutionContext.cpp#178]" target="_blank" rel="external">source code</a>, we can see error is sanitized, if the <code>corsStatus</code> does not satisify some condition.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ExecutionContext::shouldSanitizeScriptError(<span class="keyword">const</span> String&amp; sourceURL, AccessControlStatus corsStatus)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (corsStatus == OpaqueResource)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> !(securityOrigin()-&gt;canRequestNoSuborigin(completeURL(sourceURL)) || corsStatus == SharableCrossOrigin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> ExecutionContext::dispatchErrorEvent(PassRefPtrWillBeRawPtr&lt;ErrorEvent&gt; event, AccessControlStatus corsStatus)</span><br><span class="line">&#123;</span><br><span class="line">    EventTarget* target = errorEventTarget();</span><br><span class="line">    <span class="keyword">if</span> (!target)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    RefPtrWillBeRawPtr&lt;ErrorEvent&gt; errorEvent = event;</span><br><span class="line">    <span class="keyword">if</span> (shouldSanitizeScriptError(errorEvent-&gt;filename(), corsStatus))</span><br><span class="line">        errorEvent = ErrorEvent::createSanitizedError(errorEvent-&gt;world());</span><br><span class="line"></span><br><span class="line">    ASSERT(!m_inDispatchErrorEvent);</span><br><span class="line">    m_inDispatchErrorEvent = <span class="keyword">true</span>;</span><br><span class="line">    target-&gt;dispatchEvent(errorEvent);</span><br><span class="line">    m_inDispatchErrorEvent = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> errorEvent-&gt;defaultPrevented();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To enable <code>SharableCrossOrigin</code> scripts, one can add <code>crossorigin</code> attribute to script tags, and, add a <code>Access-Control-Allow-Origin</code> head in scripts’ server response, just like cross orgin XHR.</p>
<p>Like this.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"http://somremotesite.example/script.js"</span> <span class="attribute">crossorigin</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>And in your server conf, say, nginx, add something like this</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server &#123;&#10;  server_name static.jscdn.com;&#10;  # blah blah blah&#10;&#10;  location ~ \.js &#123;&#10;    add_header Access-Control-Allow-Origin &#34;*&#34;;&#10;  &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="More_Browser_Quirks_and_nasty_ISP">More Browser Quirks and nasty ISP</h1><p>Modern browser will protect users’ privacy and respect developers’ CORS setting. But IE may screw both. In some unpatched Internet Exploers, all script errors are accessible in <code>onError</code> handler, regardless of their origins. But some Internet Explorers, patched, just ignore the CORS head and swallow all crossorigin error messages.</p>
<p>To catch errors in certain IEs, developers must manually wrap their code in <code>try {...} catch (e){report(e)}</code> block. Alternatively, one can use build process to wrap function, like <a href="https://github.com/BetterJS/try-wrapper" target="_blank" rel="external">this</a>.</p>
<p><a href="https://github.com/angular/zone.js" target="_blank" rel="external">Zone</a> should also be a good candidate for error tracking, and does not require build process. Though I have not tried it.</p>
<p>Another issue in error tracking is ISP and browser extensions. <code>onError</code> callbacks will receive all error in the host page. It usually contains many ISP injected script and extension script which trigger false alarm errors. So wrapping code in <code>try ... catch</code> may be a better solution.</p>
<p><strong>UPDATE:</strong></p>
<p>It seems <code>Zone</code> like hijacking method has been used in error tracking product. Like <a href="https://bugsnag.com/blog/js-stacktraces" target="_blank" rel="external">BugSnag</a>. The basic idea is: If code is executed synchronously, then it can be <code>try ... catch ...</code>ed in one single main function. If code is executed asynchronously, then, by wrapping all function that takes callback, one can wrap all callbacks in <code>try ...catch ...</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrap</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Ensure we only wrap the function once.</span></span><br><span class="line">    <span class="keyword">if</span> (!func._wrapped) &#123;</span><br><span class="line">        func._wrapped = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                func.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(e.message, <span class="string">"from"</span>, e.stack);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> func._wrapped;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The above code will wrap all <code>func</code> in try and catch. So when error occurs, it will be always logged. However, calling wrapper function in every async code usage is impractical. We can invert it! Not wrapping callbacks, but wrapping functions that consume callbacks, say, <code>setTimeout</code>, <code>addEventListener</code>, etc. Once these async code entries have been wrapped, all callbacks are on track.</p>
<p>And, because JavaScript is prototype based language, we can <code>hijack</code> the <code>EventTarget</code> prototype and automate our error tracking code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> addEventListener = <span class="built_in">window</span>.EventTarget.prototype.addEventListener;</span><br><span class="line"><span class="built_in">window</span>.EventTarget.prototype.addEventListener = <span class="function"><span class="keyword">function</span> (<span class="params">event, callback, bubble</span>) </span>&#123;</span><br><span class="line">    addEventListener.call(<span class="keyword">this</span>, event, wrap(callback), bubble);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="IE9_and_friends">IE9 and friends</h1><p>Sadly, IE does not give us stack on error. But we can hand-roll our call stack by traversing <code>argument.callee.caller</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IE &lt;9</span></span><br><span class="line"><span class="built_in">window</span>.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">message, file, line, column</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> column = column || (<span class="built_in">window</span>.event &amp;&amp; <span class="built_in">window</span>.event.errorCharacter);</span><br><span class="line">    <span class="keyword">var</span> stack = [];</span><br><span class="line">    <span class="keyword">var</span> f = <span class="built_in">arguments</span>.callee.caller;</span><br><span class="line">    <span class="keyword">while</span> (f) &#123;</span><br><span class="line">        stack.push(f.name);</span><br><span class="line">        f = f.caller;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(message, <span class="string">"from"</span>, stack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Garbage_Collector_Issue">Garbage Collector Issue</h1><p>Error reporting is usually done by inserting an <code>Image</code> of which the <code>url</code> is the address of logging server comprised of encoded error info in query string.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">'xxx'</span>;</span><br><span class="line"><span class="keyword">new</span> Image().src = url;</span><br></pre></td></tr></table></figure>
<p>But the <code>Image</code> has no reference to itself, and JS engine’s garbage collector will collect it before the request is sent. So one can assign the <code>Image</code> to a variable to hold its reference, and withdraw the reference in the <code>onload/onerror</code> callback.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> win = <span class="built_in">window</span>;</span><br><span class="line"><span class="keyword">var</span> n = <span class="string">'jsFeImage_'</span> + _make_rnd(),</span><br><span class="line">  img = win[n] = <span class="keyword">new</span> Image();</span><br><span class="line">img.onload = img.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  win[n] = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line">img.src = url;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/11/17/js-tracker/" data-id="cihbv2j9f000y2qejyuoc8ypq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-angular2-quick-start" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/25/angular2-quick-start/" class="article-date">
  <time datetime="2015-10-24T16:00:00.000Z" itemprop="datePublished">2015-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/25/angular2-quick-start/">The Real Angular2 quick start</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Angular2 <a href="https://angular.io/docs/ts/latest/quickstart.html" target="_blank" rel="external">official page</a> wants you to make some dirty hack to get the fastest  <code>hellow world</code> in Angular2. But it immediately requires to correct your first sin in the same 5-min quickstart page. Maybe it is possible for a newcomert to set up Angular2 properly in 5 minutes, but reverting previous dirty hack and then setting the correct thing up are annoying. So here is the REAL Angular2 quickstart that does not piss you off.</p>
<p><strong>DISCLAIMER</strong>: Knowledge about <a href="https://www.npmjs.com/" target="_blank" rel="external">npm</a>, <a href="https://github.com/Microsoft/TypeScript/wiki/tsconfig.json" target="_blank" rel="external">TypeScript</a> and <a href="https://github.com/systemjs/systemjs/blob/master/docs/config-api.md" target="_blank" rel="external">SystemJS</a> is recommended.<br>This quickstart deliberately skips explanation on the config and shell code for real real speed.</p>
<h1 id="Step_1:_Create_a_new_folder_for_our_application_project-">Step 1: Create a new folder for our application project.</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir angular2-quickstart</span><br><span class="line"><span class="built_in">cd</span> angular2-quickstart</span><br><span class="line">mkdir -p src/app</span><br></pre></td></tr></table></figure>
<h1 id="Step_2:_Install_npm_packages">Step 2: Install npm packages</h1><p>First step towards front end project as usual…<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">npm i angular2@<span class="number">2.0</span>.<span class="number">0</span>-alpha.<span class="number">44</span> systemjs@<span class="number">0.19</span>.<span class="number">2</span> --save --save-exact</span><br><span class="line">npm i typescript live-server --save-dev</span><br></pre></td></tr></table></figure></p>
<p>Version number sucks, but it will be removed after Angular2’s public stable release.<br>We need to install angular2 and TypeScript as dependency, of course. SystemJS is used to load our app(alternatively one can use webpack or browserify).<br>Live-server gives us live-reloading in developement.</p>
<h1 id="Step_4:_Set_up_npm_script_tasks">Step 4: Set up npm script tasks</h1><p>Let’s define some useful command.<br><strong>Find and replace</strong> the <code>script</code> section in <code>package.json</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "tsc": "tsc -p src -w",</span><br><span class="line">    "start": "live-server --open=src"</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><code>npm run tsc</code> compiles and watches file changes. <code>npm start</code> runs the live-reload server.</p>
<h1 id="Step_5:_Create_our_first_Angular2_component">Step 5: Create our first Angular2 component</h1><p><strong>Add a new file</strong> called <code>app.ts</code> in <code>src/app</code><br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Component, bootstrap&#125; from <span class="string">'angular2/angular2'</span>;</span><br><span class="line">@Component(&#123;</span><br><span class="line">    selector: <span class="string">'my-app'</span>,</span><br><span class="line">    template: <span class="string">'&lt;h1&gt;My First Angular 2 App&lt;/h1&gt;'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> AppComponent &#123; &#125;</span><br><span class="line">bootstrap(AppComponent);</span><br></pre></td></tr></table></figure></p>
<h1 id="Step_6:_Create_our_entrance_html">Step 6: Create our entrance html</h1><p><strong>Create</strong> an index.html in <code>src</code> foler.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>Angular 2 QuickStart<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"../node_modules/systemjs/dist/system.src.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"../node_modules/angular2/bundles/angular2.dev.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="groovy"></span><br><span class="line">      System.config(&#123;</span><br><span class="line"><span class="label">        packages:</span> &#123;</span><br><span class="line">          <span class="string">'app'</span>: &#123;<span class="string">defaultExtension:</span> <span class="string">'js'</span>&#125; <span class="comment">// defaultExtension makes require `app/app` works without `.js`</span></span><br><span class="line">          <span class="comment">// more packages config goes here</span></span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      System.<span class="keyword">import</span>(<span class="string">'app/app'</span>);</span><br><span class="line">    </span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">my-app</span>&gt;</span>loading...<span class="tag">&lt;/<span class="title">my-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="Step_7:_Compile_TypeScript">Step 7: Compile TypeScript</h1><p><strong>Create tsconfig.json</strong> in the <code>src</code> folder.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">compilerOptions</span>": <span class="value">&#123;</span><br><span class="line">    "<span class="attribute">target</span>": <span class="value"><span class="string">"ES5"</span></span>,</span><br><span class="line">    "<span class="attribute">module</span>": <span class="value"><span class="string">"commonjs"</span></span>,</span><br><span class="line">    "<span class="attribute">sourceMap</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">    "<span class="attribute">emitDecoratorMetadata</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">    "<span class="attribute">experimentalDecorators</span>": <span class="value"><span class="literal">true</span></span>,</span><br><span class="line">    "<span class="attribute">removeComments</span>": <span class="value"><span class="literal">false</span></span>,</span><br><span class="line">    "<span class="attribute">noImplicitAny</span>": <span class="value"><span class="literal">false</span></span><br><span class="line">  </span>&#125;</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<p>And then, in a <strong>new terminal window</strong>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run tsc</span><br></pre></td></tr></table></figure></p>
<h1 id="Step_8:_Run_the_app!">Step 8: Run the app!</h1><p>And in <strong>yet another new terminal window</strong>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure></p>
<p>You should see <code>My First Angular2  App</code> in your browser.</p>
<h1 id="Hooray!">Hooray!</h1><p>Now you can make some changes to your source file. <code>tsc</code> compiles file on the fly and <code>live-server</code> automatically refreshes the browser!</p>
<p>Hope you are not pissed off by this quickstart.</p>
<p><em>P.S. Final structure</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular2-quickstart&#10;&#9500;&#9472;&#9472; node_modules&#10;&#9500;&#9472;&#9472; src&#10;&#9474;    &#9500;&#9472;&#9472; app&#10;|    &#9474;    &#9492;&#9472;&#9472; app.ts&#10;&#9474;    &#9500;&#9472;&#9472; index.html&#10;&#9474;    &#9492;&#9472;&#9472; tsconfig.json&#10;&#9492;&#9472;&#9472; package.json</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/10/25/angular2-quick-start/" data-id="cihbv2j7o00002qejey6j2mzp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/">TypeScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-typescript-ctags" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/10/typescript-ctags/" class="article-date">
  <time datetime="2015-10-10T10:26:14.000Z" itemprop="datePublished">2015-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/10/typescript-ctags/">Updated Ctags for TypeScript</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>TypeScript has a decent tooling chain. However, sometimes a simple <code>ctags</code> is more handy and efficient.</p>
<p>Here is a updated ctag configuration for TypeScript. It supports more features in TS 1.5+.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--langdef=typescript&#10;--langmap=typescript:.ts&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*class[ \t]+([a-zA-Z0-9_]+)/\2/c,classes/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*abstract class[ \t]+([a-zA-Z0-9_]+)/\2/a,abstract classes/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*module[ \t]+([a-zA-Z0-9_]+)/\2/n,modules/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*type[ \t]+([a-zA-Z0-9_]+)/\2/t,types/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*namespace[ \t]+([a-zA-Z0-9_]+)/\2/n,modules/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*function[ \t]+([a-zA-Z0-9_]+)/\2/f,functions/&#10;--regex-typescript=/^[ \t]*export[ \t]+var[ \t]+([a-zA-Z0-9_]+)/\1/v,variables/&#10;--regex-typescript=/^[ \t]*var[ \t]+([a-zA-Z0-9_]+)[ \t]*=[ \t]*function[ \t]*\(\)/\1/l,varlambdas/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*(public|private)[ \t]+(static)?[ \t]*([a-zA-Z0-9_]+)/\4/m,members/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*interface[ \t]+([a-zA-Z0-9_]+)/\2/i,interfaces/&#10;--regex-typescript=/^[ \t]*(export)?[ \t]*enum[ \t]+([a-zA-Z0-9_]+)/\2/e,enums/</span><br></pre></td></tr></table></figure>
<p>For more vim integration, you can give <a href="https://github.com/HerringtonDarkholme/yats.vim" target="_blank" rel="external">YATS</a> a look</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/10/10/typescript-ctags/" data-id="cihbv2j8d000e2qejrnv6ftp7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/">TypeScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-paamayim-nekudota" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/09/paamayim-nekudota/" class="article-date">
  <time datetime="2015-06-08T16:00:00.000Z" itemprop="datePublished">2015-06-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/09/paamayim-nekudota/">Paamayim Nekudota Operator in ES7</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <img src="/images/50799930.jpg">
<p><a href="http://www.pixiv.net/member_illust.php?mode=medium&amp;illust_id=50799930" target="_blank" rel="external">Source: ななろば華 - 雨上がりタペストリー</a></p>
<p>Recently <a href="http://babeljs.io/blog/2015/05/14/function-bind/" target="_blank" rel="external">Babel</a> supports <a href="https://github.com/zenparsing/es-function-bind" target="_blank" rel="external">Function Bind Syntax</a> in ES7. A.K.A <a href="http://en.wikipedia.org/wiki/Scope_resolution_operator" target="_blank" rel="external">Paamayim Nekudotayim</a> Operator.(it should be Paamayim Nekudatayim, though)</p>
<p>It inherits the spirit of Golang’s method, Switf’s <code>extension</code>, Scala’s <code>implicit class</code>, Ruby’s <code>instance_exec</code>, Haskell’s typeclass. While ES6 normalizes, and thus constrains, inheritance in JavaScript, <code>::</code> brings about ad-hoc virtual method to extends class’s behavior.</p>
<p>Thanks to JavaScript’s prototype based and dynamic typing nature, Paamayim Nekudata introduces least semantic complexity and grants best expressiveness. It is much more concise than <code>method.call</code> in previous JS or <code>instance_exec</code> in Ruby. Using double colon <code>::</code>, other than dot <code>.</code> provides visual cue to the source and definition of virtual method, which is more clear and less confusing than Swift’s <code>extension</code> or Scala’s <code>implicit class</code>. Extension to native object is trivial if one uses this new syntax. We can easily write a underscore like itertool library and apply its API directly on native array. This cannot be done without hacking (or screwing up) Array.prototype in ES6-. Both proposal and implementation on Function Bind Syntax are easy and straightforward, again, thanks to JS’ nature.</p>
<p>However, Function Bind Syntax does not work well with type checking, for now. Current candidate proposals on ES type system does not cover <code>this</code> keyword in function body. TypeScript simply waives type checking or forbids referencing <code>this</code> in function body. Flow is the only type checker that open method which is aware of <code>this</code> context. However, the type checking on open method is implicit to code authors. One cannot explicitly annotate function’s this type and type checking on open method is a sole compiler’s matter.</p>
<p>Nontheless, it is great feature! I’m lovin it! Try it out!</p>
<p>Source: <a href="http://babeljs.io/blog/2015/05/14/function-bind/" target="_blank" rel="external">http://babeljs.io/blog/2015/05/14/function-bind/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/06/09/paamayim-nekudota/" data-id="cihbv2j9c000w2qejw3nbdbnc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-scala-sam" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/24/scala-sam/" class="article-date">
  <time datetime="2015-01-24T08:21:47.000Z" itemprop="datePublished">2015-01-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/24/scala-sam/">Explaining Scala SAM type</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <img src="/images/42665600.jpg">
<p><a href="http://www.pixiv.net/member_illust.php?mode=medium&amp;illust_id=42665600" target="_blank" rel="external">source</a></p>
<p>For better syntax and user friendliness (and a lot more), Java 8 introduces <a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-state-3.html" target="_blank" rel="external">SAM</a> type, Single Abstract Method type, starting to embrace the functional programming world.</p>
<p>Previous to 1.8, Java already has somewhat a (bulky and leaky) type of closure: annonyous inner classes. For example, to start a working thread in Java usually requires following trivial but bloated statements, without a lexical <code>this</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from android developer guide</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Bitmap b = loadImageFromNetwork(<span class="string">"http://www.example.org/image.gif"</span>);</span><br><span class="line">      mImageView.setImage(b);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Two classes, one method. The introduction of SAM type greatly reduces the syntactical overhead of Java.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> Thread(#&#123; -&gt;</span><br><span class="line">    mImage.setImage(loadImageFromNetwork(<span class="string">"/image.gif"</span>));</span><br><span class="line">  &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I’m not explaining Java8’s new features here, as a Scala user has already relished the conciseness and expressiveness of functional programming.</p>
<p>So, why would scala user cares about SAM type in Java? I would say that interoperation with Java and performance are the main concerns here.</p>
<p>Java8 introduces <code>Function</code> type, which is widely used in library like <code>stream</code>. Sadly, <code>Function</code> is not that of scala. Scala compiler just frowns at you using scala native function with Stream.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.<span class="type">Arrays</span></span><br><span class="line"><span class="type">Arrays</span>.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>).stream.map((i: <span class="type">Int</span>) =&gt; i * <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;console&gt;: error: type mismatch;</span></span><br><span class="line"><span class="comment">//  found   : Int =&gt; Int</span></span><br><span class="line"><span class="comment">//  required: java.util.function.Function[_ &gt;: Int, _]</span></span><br></pre></td></tr></table></figure>
<p>Side notes: because function parameter is in a contravariant position,  <code>Function[_ &gt;: Int, _]</code> has a lower bound Int rather than a upper bound.<br>That is, the function passed as argument must accept types that are super types of <code>Int</code>.</p>
<p>One can manually provide implicit conversion here to transform scala function types to java function types. However, <a href="http://www.tikalk.com/incubator/simulating-sam-closures-scala/" target="_blank" rel="external">implementing</a> such implicit conversion is of no fun. The implementation is either not generic enough, or requires mechanical code duplication(another alternative is advanced macro generation). Compiler support is more ideal, not only because it generates more efficient byte code, but also because this precludes incompatibility across different implementations.</p>
<p><strong>SAM type is enabled by <code>-Xexperimental</code> flag in scala 2.11.x flags. Specifically, in scala 2.11.5, SAM type is better <a href="https://github.com/scala/scala/pull/4101" target="_blank" rel="external">supported</a>.</strong><br>SAM gets eta-expansion(one can use a method from another class as SAM), overloading(overloaded function/method can also accept functions as SAM) and existential type support in scala 2.11.5.</p>
<p>Basic usage os SAM is quite simple, if a <code>trait/abstract class</code> with <em>exactly one</em> <code>abstract method</code>, then a <code>Function</code> of the <em>same parameter and return type</em> of the abstract method can be converted into the <code>trait/abstract class</code>.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Flyable</span> &#123;</span></span><br><span class="line">  <span class="comment">// exactly one abstracg method</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fly</span>(</span>miles: <span class="type">Int</span>): <span class="type">Unit</span></span><br><span class="line">  <span class="comment">// optional concrete object</span></span><br><span class="line">  <span class="function"><span class="keyword">val</span> <span class="title">name</span> =</span> <span class="string">"Unidentified Flyable Object"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to reference SAM type itself</span></span><br><span class="line"><span class="comment">// create a named self-referencing lambda expression</span></span><br><span class="line"><span class="function"><span class="keyword">val</span> <span class="title">ufo</span>:</span> <span class="type">Flyable</span> = (m: <span class="type">Int</span>) =&gt; println(s<span class="string">"$&#123;ufo.name&#125; flies $m miles!"</span>)</span><br><span class="line">ufo.fly(<span class="number">123</span>)</span><br><span class="line"><span class="comment">// Unidentified Flyable Object flies 123 miles!</span></span><br></pre></td></tr></table></figure>
<p>Easy Peasy. So for the <code>stream</code> example, if compiler has the <code>-Xexperimental</code> flag, scala will automatically change the function to java’s function, which grant scala user a seamless experience with the library.</p>
<p>Usually, you don’t need SAM in scala, as scala already has first class generic function type, eta-expansion and a lot more. SAM reduces the readability as implicit conversion does. One can always use type alias to give function a more understandable name, instead of using SAM. SAM type cannot be pattern matched, <a href="https://issues.scala-lang.org/browse/SI-8429" target="_blank" rel="external">at least for now</a>.</p>
<p>However, interoperating with Java requires SAM. And self-referencing SAM gives you additional flexibity in designing API. SAM also generates more efficient byte code since SAM has a native byte code counterpart. Using annonymous class for event handler or callback can be more pleasant in Scala just as in Java.</p>
<p>Anyway, adding a feature is <a href="https://github.com/scala/scala/pull/4101" target="_blank" rel="external">easy</a>, but adding a feature that couples with edge case is hard. Scala already has bunches of features(variance, higher kinded, type level, continuation), whether SAM will gain its popularity is still an open question.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/01/24/scala-sam/" data-id="cihbv2j8u000n2qejalg8u5pr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-typescript-rant" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/17/typescript-rant/" class="article-date">
  <time datetime="2015-01-16T16:00:00.000Z" itemprop="datePublished">2015-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/17/typescript-rant/">Rant on Typescript type guard</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <img src="/images/hisuitei.jpg">
<p>source: <a href="http://hisuitei.com" target="_blank" rel="external">Ad: hisuitei</a></p>
<p>Recently Typescript team has released Typescript 1.4, adding a new feature called <code>Union Type</code> which is intended for better incorporation into native Javascript.<br>Type guard, as a natural dyad of union type, also comes into Typescript world. But sadly, Microsoft choose a bizzare way to introduce type guard as they said in the <a href="https://github.com/Microsoft/TypeScript/wiki/What%27s-new-in-TypeScript%3F#typescript-14" target="_blank" rel="external">manual</a></p>
<blockquote>
<p>TypeScript now understands these conditions and will change type inference accordingly when used in an if block.</p>
</blockquote>
<p>It <em>accepts and only accepts</em> conditional statement like <code>if (typeof x === &#39;string&#39;)</code> as type guard.<br>Typescript now creates new type like <code>number | string</code> meaning a type of either number or string.<br>Users can further refine the type by comparing the value <code>typeof</code> gives, like the example below:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCustomer</span>(<span class="params">name: &#123; firstName: <span class="built_in">string</span>; lastName: <span class="built_in">string</span> &#125; | <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">"string"</span>) &#123;</span><br><span class="line">        <span class="comment">// Because of the typeof check in the if, we know name has type string</span></span><br><span class="line">        <span class="keyword">return</span> &#123; fullName: name &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Since it's not a string, we know name has</span></span><br><span class="line">        <span class="comment">// type &#123; firstName: string; lastName: string &#125;</span></span><br><span class="line">        <span class="keyword">return</span> &#123; fullName: name.firstName + <span class="string">" "</span> + name.lastName &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Both customers have type &#123; fullName: string &#125;</span></span><br><span class="line"><span class="keyword">var</span> customer = createCustomer(<span class="string">"John Smith"</span>);</span><br><span class="line"><span class="keyword">var</span> customer2 = createCustomer(&#123; firstName: <span class="string">"Samuel"</span>, lastName: <span class="string">"Jones"</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>I would rather say this is a bad idea because:</p>
<ol>
<li>it intermixes type level constucts with value level constructs.</li>
<li>for complex and flexible language like javascript, microsoft’s approach is unable to handle various expressions regarding types.</li>
</ol>
<p>Value level contructs are expression or statements dealing with values, e.g. assignment, comparison. <code>typeof</code> and <code>instanceof</code> in Javascript are value level constructs because they generate boolean value, and their values can be passed to other variable or compared with other variable. Value type constucts do imply types, say, creating a new object of specific type, but they do not explicitly manipulate the types of expressions. There is no type casting Javascript can do. On the other hand, type level constructs deals with types, for example, type annotation and generics.</p>
<p>Doubling <code>typeof</code> as type guard blurs the demarcation between type level and value level, and naturally reduces program’s readability(somewhat subjective claim though). A variable can, without distinct syntax, change its type in a conditional block. <code>if</code> branching is ubiquitous typescript programs, from hello-world toys to cathedral-like projects. It’s quite hard to find the “type switch” for union type among other irrelevant <code>if</code>s. Also, one has to pay attention to call correct method of a same variable in different branches. So Typescript’s type guard introduces a new <code>type scope</code> different from both lexical scope and function scope. It also cripples the compiler because now compiler has to check whether the condition in a <code>if</code> parentheses is type guard.</p>
<p>What’s worse? Type guard is a value level constructs so it can interact with all other language constucts. But microsoft does not intend to support that. None of the following code compiles in Typescript 1.4.1, but they ought to run correctly in plain javascript, if they can be compiled.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">function testNot(x: string|number|Function) &#123;</span><br><span class="line">  var isNonNum = typeof x !== 'number'</span><br><span class="line">  if (isNonNum) return x.length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function testReturn(x: string|number) &#123;</span><br><span class="line">  if (typeof x === 'number') return;</span><br><span class="line">  return x.length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function testReturn(x: string|number) &#123;</span><br><span class="line">  if (typeof x === 'number') throw new Error('error type')</span><br><span class="line">  return x.length</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function testFor(xs: (string|number)[]) &#123;</span><br><span class="line"> for(var i = 0, x = xs[i]; typeof x === 'string'; i++) &#123;</span><br><span class="line">   console.log(x.length)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function testWhile(xs: [](string|number)) &#123;</span><br><span class="line">  var i = 0;</span><br><span class="line">  while (typeof xs[i] === 'string') &#123;</span><br><span class="line">    console.log(xs[i].length)</span><br><span class="line">    i++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function testFilter(xs: (string|number)[]) &#123;</span><br><span class="line">  xs.filter((x) =&gt; typeof x === 'string').map((x) =&gt; x.length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Indeed, Typescript is not the first to mix type level and value level. Language constructs like <code>Pattern Match</code> also do that(and usually introduce bugs related to type inference, see scala bug track). But at least Pattern Match is a specialized syntax that does not interact much with other syntax. But Type guard is, well, too ubiquitous to be good.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2015/01/17/typescript-rant/" data-id="cihbv2j8b000b2qej2d9o6md4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yagami" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/12/28/yagami/" class="article-date">
  <time datetime="2014-12-27T16:00:00.000Z" itemprop="datePublished">2014-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/28/yagami/">大雅雅于俗</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>问君何能尔，心远地自偏。</p>
</blockquote>
<img src="/images/yagami.jpg">
<p>  我跟你讲，八神老师的LL本才是横跨氪金手游和同人薄本两界的旗舰之作。</p>
<p>  不要看每本本子只有薄薄三十几页，但每一页都体现了老师对氪金手游业的大见识：一切氪金的本质，与“恶女榨金”无二。老师的本子虽薄，却为ACG产业，乃至现代文化消费形式，描绘了一张鸟瞰图。</p>
<p>如若看官仅仅以无鸟事为鸟找事的心态去看LL本， 看到的不过是人物单方面榨取主人公体液的画面。进入了贤者状态的上级读者，才能看到老师在本子中表达的良苦用心。八神老师的整个作品都是个隐喻，从注射器到温度计，无一不暗示了氪金手游的运营手段。它们都有一个简单明了的目的：尽一切奇技淫巧，榨出玩家钱包里最后一滴金。</p>
<p>本子中的主人公被描写为一个被动的体液机器，这和免费增值(Freemium)的商业模式中将消费者定位成消费机器的思路实际是异曲同工的。偶像不断用各色工具刺激玩家产生快感，玩家在这个过程中形成了氪金与成就的关联概念，在老师本子中，就是以受虐与快感关联的受虐情节所体现出来的。</p>
<p>运营在情节和宣传中构造出的“偶像”、“奋斗”等概念，实际上是对玩家消费欲望的一个“改装”(distortion)，让消费欲能被玩家自身和玩家所在的社会环境所接受。在本子中刺激腺体的桥段，影射了游戏对玩家消费欲的刺激（生理层次上，对腹侧被盖区的刺激）。然而八神老师的文笔隽永之处就在于，他的笔触白虚伪的改装一一清除，入目三分地刻画了氪金手游的榨金本色。这一点在老师SC60的作品《 soldier money game》中展现无余。</p>
<p>称LL薄本为俗萌之物，恰恰是没有理解八神秋一老师的用心之处。视角从薄本本身放开，提升到一个“元薄本”(meta-usuihon)的高度，才能品读出LL本中的精妙之处。八神老师的作品看似大俗，但作品的旨味却是大雅。在大俗的故事中反思了现代人的消费行为，才是艺术家在当代社会中的应有作为。</p>
<p>作为人民艺术家，如果一味追求艺术形式上的“雅”，只会和观众拉开远非“一步之遥”的距离。所谓小雅雅于形，中雅雅于意，大雅雅于俗，八神老师的作品，不可不谓大俗大雅、雅俗共赏之作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2014/12/28/yagami/" data-id="cihbv2j8600062qej8zbsxpkh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/misc/">misc</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-typelevel-html" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/01/typelevel-html/" class="article-date">
  <time datetime="2014-11-01T10:26:14.000Z" itemprop="datePublished">2014-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/01/typelevel-html/">typelevel-html</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Type level programming is a technique that exploits type system to represents information and logic, to the extent of language’s limit.</p>
<p>Since values are encoded by variable’s type, type level drives compiler to validate logic or even determine program’s output.<br>All validation and computation are conducted statically at compiling phase, so the greatest benefit of type-level programming is its safety and reliability.</p>
<p>As a rule of thumb, the more dynamic code is, the more flexible it can computes. Type level programming require all logic encoded into the source code. It is to hard to cram all logic into type system, as handling whimsical input from external source is either impossible or reduce source code to unwieldy state machine. So the niche of type level programming is usually encoding, pickling or parsing.</p>
<p>But there is field where code is statically written: GUI. HTML template is hard coded in source. Type level can be used as linting and validation in html edition, especially in authoring web components. A piece of HTML fragment can be encoded in ordinary object, with type denoting its structure. Once the structure of HTMl is fixed, the output of JavaScript and css can be determined as well.<br>This is more helpful when one wants to make component. A tab-container must have tab-pane as child, and a tab-pane must live within a tab-container. Current approach of constraining HTML structure is encoding requirements in JavaScript and checking it in runtime. For example, angular uses <code>require: &#39;^parentDirective&#39;</code> to express the constraints and enable directive communication. If the component is programmatically constructed, using type annotation is a natural way to express the constraints. (As in Angular 2.0, <code>query&lt;ChildDirective&gt;</code>). We can go further in a language with full-bloomed type system.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trait Tag&#10;class Concat[A &#60;: Tag, B &#60;: Tag](a: A, b: B) extends Tag&#10;trait NestTag[A &#60;: Tag] extends Tag &#123;&#10;  type Child = A&#10;&#125;&#10;trait Inline extends Tag&#10;trait Block extends Tag&#10;case class div[T &#60;: Tag](t :T = null) extends NestTag[T] with Block&#10;case class p[T &#60;: Tag](t :T = null) extends NestTag[T] with Block&#10;case class a[T &#60;: Inline](t :T = null) extends NestTag[T] with Inline&#10;&#10;implicit class PlusTag[A &#60;: Tag](a: A) &#123;&#10;  def +[B &#60;: Tag](b: B) = new Concat(a, b)&#10;&#125;&#10;&#10;class Contains[A &#60;: Tag, C[_ &#60;: Tag] &#60;: NestTag[_], T[_ &#60;: Tag] &#60;: NestTag[_]]&#10;&#10;case class jQ[A &#60;: Tag, C[_ &#60;: Tag] &#60;: NestTag[_]](c: C[A]) &#123;&#10;  def has[T[_ &#60;: Tag] &#60;: NestTag[_]](implicit ev: Contains[A, C, T]) = true&#10;&#125;&#10;&#10;implicit def htmlEq[A &#60;: Tag, C[_ &#60;: Tag] &#60;: NestTag[_], T[_ &#60;: Tag] &#60;: NestTag[_]](implicit ev: C[A] =:= T[A]) =&#10;  new Contains[A, C, T]&#10;implicit def recurEq[A &#60;: Tag, B[_ &#60;: Tag] &#60;: NestTag[_], C[_ &#60;: Tag] &#60;: NestTag[_], T[_ &#60;: Tag] &#60;: NestTag[_]]&#10;  (implicit ev: Contains[A, B, T]) = new Contains[B[A], C, T]&#10;&#10;val ele = div(&#10;  p(&#10;    a()&#10;  )&#10;)&#10;val r = jQ(ele).has[p]&#10;println(r)</span><br></pre></td></tr></table></figure>
<p>The code above is just a demo. All html elements has type that denotes its structure. And one can tell whether a tag is in a html elemnt by calling <code>jQ(ele).has[Tag]</code>. (Note: ele is value level variable and Tag is a type level constructor.) And inline element cannot contains block element, because inline element’s child must be a subtype of <code>inline</code>.</p>
<p>Programmatical markup has several benefits:</p>
<ol>
<li>no switching between script and template</li>
<li>static type checking</li>
<li>component dependency requirements</li>
<li>component communication</li>
<li>subtyping, inheritance… Classical OOP features</li>
<li>relatively clean layout (though not as concise as Jade/Slim)</li>
</ol>
<p>The biggest problem is, well, type level templates is strongly constrained by host language. Dynamic languages simply cannot have it. Users of classical static typed language without type inference cannot afford the verbosity of deeply nested type. And languages capable of type level have different approaches and implementation towards Type Level Programming.</p>
<p>After all, type level is too crazy…, at least for daily business logic.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2014/11/01/typelevel-html/" data-id="cihbv2j8h000g2qejwmbsef4z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-scala-operator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/30/scala-operator/" class="article-date">
  <time datetime="2014-09-30T12:23:16.000Z" itemprop="datePublished">2014-09-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/09/30/scala-operator/">Scala Generalized Type constraints</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Generalized Type Constraints, also known as <code>&lt;:&lt;</code>, <code>&lt;%&lt;</code>(deprecated though) and <code>=:=</code>, also known as type relation operator, or call <a href="http://stackoverflow.com/questions/2603003/operator-in-scala/" target="_blank" rel="external">whatever</a> you want, are not operators but identifiers. It’s quite confusing for new comers to distinguish them from operators, well…, identifiers which are not that esoteric.</p>
<p>This is just plain Scala feature that non-alphanum symbols can act as legal identifiers, just like <code>+</code> method.<br>More specifically, they are type-constructors. But before we inspect their implementations, let’s first consider their usage.</p>
<h1 id="Usage">Usage</h1><p>You want to implement a generic container for every type, however, you also want to add a special method that only applies to <code>Special</code> type. (notice: this is different from the annotation <code>@specialized</code> which deals with JVM’s primitive type. Here <code>Special</code> is just a plain old scala type)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span>[</span><span class="type">A</span>](value: <span class="type">A</span>) &#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">diff</span>[</span><span class="type">A</span> &lt;: <span class="type">Int</span>](b: <span class="type">Int</span>) = value - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BOOM</span></span><br><span class="line"><span class="comment">// error: value - is not a member of type parameter A</span></span><br><span class="line"><span class="comment">//    def diff[A &lt;: Int](b: A) = value - b</span></span><br></pre></td></tr></table></figure>
<p>Why? The type bound <code>A &lt;: Int</code> does not work. <code>A</code> has been defined at the class declaration, in the class body Scala compiler requries every type bound is consistent with A’s definition. Here, <code>A</code> has no bound so it is bounded by <code>Any</code>, not <code>Int</code>.</p>
<p>Instead of setting type bound, methods may ask for some kinds of specific <em>ad-hoc</em> “evidence” for a type.</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; <span class="class"><span class="keyword">class</span> <span class="title">Container</span>[</span><span class="type">A</span>](value: <span class="type">A</span>) &#123;</span><br><span class="line">  <span class="comment">// other generic methods for A</span></span><br><span class="line">  <span class="comment">/* blah blah */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// specialized method for Int</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">addIt</span>(</span><span class="keyword">implicit</span> evidence: <span class="type">A</span> =:= <span class="type">Int</span>) = <span class="number">123</span> + value</span><br><span class="line">&#125;</span><br><span class="line">defined <span class="class"><span class="keyword">class</span> <span class="title">Container</span></span><br><span class="line"></span></span><br><span class="line">scala&gt; (<span class="keyword">new</span> <span class="type">Container</span>(<span class="number">123</span>)).addIt</span><br><span class="line">res11: <span class="type">Int</span> = <span class="number">246</span></span><br><span class="line"></span><br><span class="line">scala&gt; (<span class="keyword">new</span> <span class="type">Container</span>(<span class="string">"123"</span>)).addIt</span><br><span class="line">&lt;console&gt;:<span class="number">10</span>: error: could not find <span class="keyword">implicit</span> value <span class="keyword">for</span> parameter evidence: =:=[java.lang.<span class="type">String</span>,<span class="type">Int</span>]</span><br></pre></td></tr></table></figure>
<p>Cool, <code>evidence</code> is an implicit provided by scala predef. And <code>A =:= Int</code> is just a type like <code>Map[Int, String]</code>, but is infixed due to scala’s syntactic sugar.</p>
<p>Scala does not impose type constraints until the specific method is called, so <code>addIt</code> does not violate <code>A</code>‘s definition. Still, given the implicit <code>evidence</code>, compiler can still infer that value in <code>addIt</code> is an sub-instance of <code>Int</code>.</p>
<p>As stated before, type constraints are <em>ad-hoc</em>. So it can achieve type inference more specific than type bound. (Fairly, this is the power of implicit).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def foo[A, B &#60;: A](a: A, b: B) = (a,b)&#10;&#10;scala&#62; foo(1, List(1,2,3))&#10;res1: (Any, List[Int]) = (1,List(1, 2, 3))</span><br></pre></td></tr></table></figure>
<p>1 is clearly <code>Int</code> but why does compiler infer it as <code>Any</code>? The <code>B &lt;: A</code> bound requires the first argument type is a super type of the second. <code>A</code> is inferred as the most general type between <code>Int</code> and <code>List[Int]</code>, <code>Any</code>.</p>
<p><code>&lt;:&lt;</code> comes to help.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def bar[A,B](a: A, b: B)(implicit ev: B &#60;:&#60; A) = (a,b)&#10;&#10;scala&#62; bar(1,List(1,2,3))&#10;&#60;console&#62;:9: error: Cannot prove that List[Int] &#60;:&#60; Int.</span><br></pre></td></tr></table></figure>
<p>Because generalized type constraints does not interfere with inference, <code>A</code> is <code>Int</code> here. Only then does the compiler find evidence for <code>&lt;:&lt;[Int, List[Int]]</code> and then fails.<br>(Actually, implicit can feedback type information back to inference, see <a href="http://apocalisp.wordpress.com/2010/07/17/type-level-programming-in-scala-part-6d-hlist%C2%A0zipunzip/" target="_blank" rel="external">typelevel programming’s</a> <code>HList</code> and scala collection library’s <code>CanBuildFrom</code>)</p>
<p>Also implicit conversion does not impact <code>&lt;:&lt;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala&#62; def foo[B, A&#60;:B] (a:A,b:B) = print(&#34;OK&#34;)&#10;&#10;scala&#62; class A; class B;&#10;&#10;scala&#62; implicit def a2b(a:A) = new B&#10;&#10;scala&#62; foo(new A, new B)  // implicit conversion!&#10;OK&#10;&#10;scala&#62; def bar[A,B](a:A,b:B)(implicit ev: A&#60;:&#60;B) = print(&#34;OK&#34;)&#10;&#10;scala&#62; bar(new A, new B)  // does not work&#10;&#60;console&#62;:17: error: Cannot prove that A &#60;:&#60; B.</span><br></pre></td></tr></table></figure>
<h1 id="Implementation">Implementation</h1><p>Actually <code>=:=</code> is just a type constructor in scala.<br>It is somewhat like <code>Map[A, B]</code>, that is,<br><code>=:=</code> is defined like</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class =:=[A, B]</span><br></pre></td></tr></table></figure>
<p>so in the implictly’s bracket, <code>Int =:= Int</code> is just a type<br><code>A =:= B</code> is the infix form of type parameterization for<br>non-alphanumeric identifier. It is equivalent to <code>=:=[A, B]</code></p>
<p>so one can define implicts for <code>=:=</code>, so that compiler can find</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implicit def EqualTypeEvidence[A]: =:=[A, A] = new =:=[A, A]</span><br></pre></td></tr></table></figure>
<p>So, when <code>implictly[A =:= B]</code> is compiled,<br>compiler tries to find the correct implicit evidence.</p>
<p>If and only If A and B are the same, say Int, the compiler can find<br><code>=:=[Int, Int]</code>, by the result of <code>implicit function EqualTypeEvidence[Int]</code></p>
<p>More compelling is &lt;:&lt;, the conformance evidence,<br>it leverages variance annotation in scala</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class &#60;:&#60;[-A, +B]&#10;implict def Conformance[A]: &#60;:&#60;[A, A] = new &#60;:&#60;[A, A]</span><br></pre></td></tr></table></figure>
<p>Consider, when <code>String &lt;:&lt; java.io.Serializable</code> is needed,<br>compiler tries to find an instance of <code>&lt;:&lt;[String, j.i.Serializable]</code><br>It can only find instance of the type <code>&lt;:&lt;[String, String]</code><br>(or another alternative <code>&lt;:&lt;[Serializable, Serializable]</code>)<br>But given the variance annotation of &lt;:&lt;,<br>since String is the very type String<br>and String is a subtype of Serializable and B is in a covariant position<br>, or, in another direction<br>snice Serializable is a supertype of String and A is in a contravariant position<br>and Serializable is the very type Serializable</p>
<p><code>&lt;:&lt;[String, String]</code> is a subtype of <code>&lt;:&lt;[String, Serializable]</code><br>So compiler finds the correct implicit instance as the evidence that<br>String is a subtype of Serializable. By the principle of subtype subsititution.<br>(Liskov)</p>
<p>Similarly we can define</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Conversion evidence&#10;&#10;class &#60;%&#60;[A &#60;% B, B]&#10;implicit def Conversion[A, B] = new &#60;%&#60;[A, B]&#10;&#10;Contra-conformance&#10;class &#62;:&#62;[+A, -B]&#10;implicit def Contra[A] = new &#62;:&#62;[A, A]</span><br></pre></td></tr></table></figure>
<p>Magic, Right?<br>The actual implementations uses singleton pattern so it is more efficient. For this illustration post, sloppy implementation is just fine :).</p>
<p>Reference:<br><a href="http://hongjiang.info/scala-type-contraints-and-specialized-methods/" target="_blank" rel="external">http://hongjiang.info/scala-type-contraints-and-specialized-methods/</a><br><a href="http://apocalisp.wordpress.com/2010/07/17/type-level-programming-in-scala-part-6d-hlist%C2%A0zipunzip/" target="_blank" rel="external">http://apocalisp.wordpress.com/2010/07/17/type-level-programming-in-scala-part-6d-hlist%C2%A0zipunzip/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2014/09/30/scala-operator/" data-id="cihbv2j8y000p2qejpwwqm2q1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-play-scala" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/08/18/play-scala/" class="article-date">
  <time datetime="2014-08-18T14:04:58.000Z" itemprop="datePublished">2014-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/08/18/play-scala/">play framework with scalate and activerecord</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>WRYYYYYYYYYYYYYYYY</p>
<p>— <cite>Dio Brando on Scala crazy dependencies</cite></p>
</blockquote>
<p>Scala works like CSS selectors in that every successor overrides its predecessor.</p>
<p>You will have to work as a detective to figure out the correct recipe to manage a huge casserole of hodgepodge.</p>
<p>To achieve a working <em>Play</em> configuration with <code>scalate</code> and <code>activerecord</code> needs:</p>
<p>In <code>build.sbt</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scalaVersion :=  <span class="string">"2.10.3"</span></span><br><span class="line"></span><br><span class="line">libraryDenpendencies ++= <span class="type">Seq</span>(</span><br><span class="line">  jdbc,</span><br><span class="line">  <span class="string">"org.scalatra.scalate"</span> %% <span class="string">"scalate-core"</span> % <span class="string">"1.7.0"</span>,</span><br><span class="line">  <span class="string">"com.github.aselab"</span> %% <span class="string">"scala-activerecord"</span> % <span class="string">"0.2.3"</span>,</span><br><span class="line">  <span class="string">"com.github.aselab"</span> %% <span class="string">"scala-activerecord-play2"</span> % <span class="string">"0.2.3"</span>,</span><br><span class="line">  <span class="string">"com.h2database"</span> % <span class="string">"h2"</span> % <span class="string">"1.3.170"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Several notes:</p>
<ol>
<li>Currently <code>scala-activerecord</code> only supports 2.10.3</li>
<li><code>scalate</code> must be <code>1.7.0</code>+ for better support on scala 2.10 but the current stable version is <code>1.6.0</code></li>
</ol>
<p>Then in the root path of play project, create a new file located at <code>app/lib/ScalateIntegration.scala</code><br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> controllers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> play.api._</span><br><span class="line"><span class="keyword">import</span> http.&#123;<span class="type">Writeable</span>, <span class="type">ContentTypeOf</span>, <span class="type">ContentTypes</span>&#125;</span><br><span class="line"><span class="keyword">import</span> mvc.<span class="type">Codec</span></span><br><span class="line"><span class="keyword">import</span> play.api.<span class="type">Play</span>.current</span><br><span class="line"><span class="keyword">import</span> org.fusesource.scalate.layout.<span class="type">DefaultLayoutStrategy</span></span><br><span class="line"><span class="keyword">import</span> collection.<span class="type">JavaConversions</span>._</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Scalate</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">import</span> org.fusesource.scalate._</span><br><span class="line">  <span class="keyword">import</span> org.fusesource.scalate.util._</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> format = <span class="type">Play</span>.configuration.getString(<span class="string">"scalate.format"</span>) <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Some</span>(configuredFormat) =&gt; configuredFormat</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; <span class="string">"scaml"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="function"><span class="keyword">val</span> <span class="title">scalateEngine</span> =</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">val</span> <span class="title">engine</span> =</span> <span class="keyword">new</span> <span class="type">TemplateEngine</span></span><br><span class="line">    engine.resourceLoader = <span class="keyword">new</span> <span class="type">FileResourceLoader</span>(<span class="type">Some</span>(<span class="type">Play</span>.getFile(<span class="string">"app/views"</span>)))</span><br><span class="line">    engine.layoutStrategy = <span class="keyword">new</span> <span class="type">DefaultLayoutStrategy</span>(engine, <span class="string">"app/views/layouts/default."</span> + format)</span><br><span class="line">    engine.classpath = <span class="string">"tmp/classes"</span></span><br><span class="line">    engine.workingDirectory = <span class="type">Play</span>.getFile(<span class="string">"tmp"</span>)</span><br><span class="line">    engine.combinedClassPath = <span class="literal">true</span></span><br><span class="line">    engine.classLoader = <span class="type">Play</span>.classloader</span><br><span class="line">    engine</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">apply</span>(</span>template: <span class="type">String</span>) = <span class="type">Template</span>(template)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Template</span>(</span>name: <span class="type">String</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span>(</span>args: java.util.<span class="type">Map</span>[<span class="type">String</span>, <span class="type">Any</span>]) = &#123;</span><br><span class="line">      <span class="type">ScalateContent</span>&#123;</span><br><span class="line">        scalateEngine.layout(name, args.map &#123;</span><br><span class="line">          <span class="keyword">case</span> (k, v) =&gt; k -&gt; v</span><br><span class="line">        &#125; toMap)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">ScalateContent</span>(</span><span class="function"><span class="keyword">val</span> <span class="title">cont</span>:</span> <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">writeableOf_ScalateContent</span>(</span><span class="keyword">implicit</span> codec: <span class="type">Codec</span>): <span class="type">Writeable</span>[<span class="type">ScalateContent</span>] = &#123;</span><br><span class="line">    <span class="type">Writeable</span>[<span class="type">ScalateContent</span>]((scalate:<span class="type">ScalateContent</span>) =&gt; codec.encode(scalate.cont))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="function"><span class="keyword">def</span> <span class="title">contentTypeOf_ScalateContent</span>(</span><span class="keyword">implicit</span> codec: <span class="type">Codec</span>): <span class="type">ContentTypeOf</span>[<span class="type">ScalateContent</span>] = &#123;</span><br><span class="line">    <span class="type">ContentTypeOf</span>[<span class="type">ScalateContent</span>](<span class="type">Some</span>(<span class="type">ContentTypes</span>.<span class="type">HTML</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Again only works on scalate 1.6.</p>
<p>Finally, according to <code>activerecord</code>‘s doc.<br>To load the plugin, in <code>conf/play.plugin</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9999:com.github.aselab.activerecord.ActiveRecordPlugin</span><br></pre></td></tr></table></figure>
<p>To configure database, in <code>conf/application.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Database configuration&#10;# ~~~~~&#10;#&#10;&#10;# Scala ActiveRecord configurations&#10;db.activerecord.driver=org.h2.Driver&#10;db.activerecord.url=&#34;jdbc:h2:mem:play&#34;&#10;db.activerecord.user=&#34;sa&#34;&#10;db.activerecord.password=&#34;&#34;&#10;&#10;# Schema definition class&#10;activerecord.schema=models.Tables</span><br></pre></td></tr></table></figure>
<p>And in <code>app/models/person.scala</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package models&#10;&#10;import com.github.aselab.activerecord._&#10;import com.github.aselab.activerecord.dsl._&#10;&#10;case class Person(@Required name: String) extends ActiveRecord&#10;object Person extends ActiveRecordCompanion[Person] with PlayFormSupport[Person]</span><br></pre></td></tr></table></figure>
<p>In <code>app/models/tabels.scala</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package models&#10;&#10;import com.github.aselab.activerecord._&#10;import com.github.aselab.activerecord.dsl._&#10;&#10;object Tables extends ActiveRecordTables with PlaySupport &#123;&#10;  val models = table[Person]&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>And finally you can try this in console</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activator console&#10;&#10;import models._&#10;import play.core.StaticApplication&#10;&#10;new StaticApplication(new java.io.File(&#34;.&#34;))&#10;&#10;Person(&#34;f@ck&#34;).save&#10;Person.findBy(&#34;name&#34;, &#34;f@ck&#34;)</span><br></pre></td></tr></table></figure>
<p>WTF have I done? I just typed mechanically what I have ferreted on Google and StackOverflow.<br>WTF is <code>play.core.StaticApplication</code> that is just one confusing <a href="https://www.playframework.com/documentation/2.2.x/api/scala/index.html#play.core.StaticApplication" target="_blank" rel="external">page</a> on the doc?<br>Speciously tantializing is the magical code under which lurk complicated dependencies.</p>
<p>Reference: <a href="http://www.javacodegeeks.com/2012/04/play-framework-2-quicktip-scala-console.html" target="_blank" rel="external">PlayframeWork Quick Tip</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://herringtondarkholme.github.io/2014/08/18/play-scala/" data-id="cihbv2j98000u2qejoktqpcf2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Scala/">Scala</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/">Vim</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/">misc</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Javascript/" style="font-size: 16.67px;">Javascript</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/Scala/" style="font-size: 20px;">Scala</a> <a href="/tags/TypeScript/" style="font-size: 13.33px;">TypeScript</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/misc/" style="font-size: 13.33px;">misc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/11/17/js-tracker/">JavaScript Error tracking in browsers</a>
          </li>
        
          <li>
            <a href="/2015/10/25/angular2-quick-start/">The Real Angular2 quick start</a>
          </li>
        
          <li>
            <a href="/2015/10/10/typescript-ctags/">Updated Ctags for TypeScript</a>
          </li>
        
          <li>
            <a href="/2015/06/09/paamayim-nekudota/">Paamayim Nekudota Operator in ES7</a>
          </li>
        
          <li>
            <a href="/2015/01/24/scala-sam/">Explaining Scala SAM type</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Herrington Darkholme<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>