<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="あくまでも紳士です">
<meta property="og:type" content="website">
<meta property="og:title" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:url" content="https://herringtondarkholme.github.io/index.html">
<meta property="og:site_name" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:description" content="あくまでも紳士です">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Abitrarily Idiosyncratic Randomness">
<meta name="twitter:description" content="あくまでも紳士です">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="https://herringtondarkholme.github.io/"/>

  <title> Abitrarily Idiosyncratic Randomness </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Abitrarily Idiosyncratic Randomness</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Hchan's Note</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/04/flow-sensitive/" itemprop="url">
                  Grok control flow based analysis in TypeScript.
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-02-04T00:00:00+08:00" content="2017-02-04">
              2017-02-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/04/flow-sensitive/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/04/flow-sensitive/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR:"></a>TL;DR:</h2><ol>
<li>Compiler does not understand control flow in closure / callback function.</li>
<li>In flow based type analysis, copmiler will be either optimistic or pessimistic. TypeScript is optimistic.</li>
<li>You can usually workaround (3) by using <code>const</code> or <code>readonly</code></li>
</ol>
<p>This is a long due introduction for TypeScript’s flow sensitive typing (also known as control flow based type analysis) since its <a href="https://github.com/Microsoft/TypeScript/wiki/What%27s-new-in-TypeScript#control-flow-based-type-analysis" target="_blank" rel="external">2.0 release</a>. It is so unfortunate that no official documentation is in TypeScript’s website for it (while both <a href="https://flowtype.org/docs/dynamic-type-tests.html#" target="_blank" rel="external">flow</a> and <a href="https://kotlinlang.org/docs/reference/typecasts.html#smart-casts" target="_blank" rel="external">kotlin</a> have!). But if you dig the issue list earnestly enough, you will always find some <a href="https://github.com/Microsoft/TypeScript/issues/9998" target="_blank" rel="external">hidden gems</a> there!</p>
<p>To put it short, a variable’s type in a <a href="https://www.wikiwand.com/en/Flow-sensitive_typing" target="_blank" rel="external">flow sensitive type system</a> can change according to the control flow like <code>if</code> or <code>while</code>. For example, you can dynamically check the truthiness of  a nullable variable and if it isn’t null, compiler will automatically cast the variable type to non-null. Sweet?</p>
<p>What can be bitter here? TypeScript is an imperative language like JavaScript. The side-effectful nature prevents compiler from inferring control flow when function call kicks in. Let’s see an example.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">let</span> a: <span class="built_in">number</span> | <span class="literal">null</span> = <span class="number">42</span></div><div class="line"></div><div class="line">makeSideEffect()</div><div class="line"></div><div class="line">a <span class="comment">// is a still a number?</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSideEffect</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// omitted...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Without knowing what <code>makeSideEffect</code> is, we cannot guarantee variable <code>a</code> is still <code>number</code>. Side effect can be as innocuous and innocent as <code>console.log(&#39;the number of life&#39;, 42)</code>, or as evil as a billion dollar mistake like <code>a = null</code>, or even a control-flow entangler: <code>throw new Error(&#39;code unreachale&#39;)</code>.</p>
<p>One might ask compiler to infer what <code>makeSideEffect</code> does since we can provide the source of the function.<br>However this is not practically feasible because of <a href="https://basarat.gitbooks.io/typescript/content/docs/types/ambient/intro.html" target="_blank" rel="external">ambient function</a> and (possibly polymorphic) recursion. Compiler will be trapped in infinite loops if we instruct it to infer arbitrary deep functions, as <a href="https://www.wikiwand.com/en/Halting_problem" target="_blank" rel="external">halting problem</a> per se.</p>
<p>So a realistic compiler must guess what a function does by a consistent strategy. Naturally we have two alternatives:</p>
<ol>
<li>Assume every function does <strong>not</strong> have relevant side effect: e.g. assignment like <code>a = null</code>. We call this <strong>optimistic</strong>.</li>
<li>Assume every function <strong>does</strong> have side effect. We call this strategy <strong>pessimistic</strong>.</li>
</ol>
<p>Spoiler: TypeScript uses optimistic strategy.</p>
<p>We will walk through these two strategies and see how they work in practice.<br>But before that let’s see some common gotchas in flow sensitive typing.</p>
<h2 id="Closure-Callback"><a href="#Closure-Callback" class="headerlink" title="Closure / Callback"></a>Closure / Callback</h2><p>Flow sensitive typing does not play well with callback functions or closures. This is explicitly mentioned in <a href="https://kotlinlang.org/docs/reference/typecasts.html#smart-casts" target="_blank" rel="external">Kotlin’s document</a>.</p>
<blockquote>
<p>var local variables - if the variable is not modified between the check and the usage and is not captured in a lambda that modifies it;</p>
</blockquote>
<p>Consider the following example.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="number">42</span> <span class="comment">// smart cast to number</span></div><div class="line">setTimeout(() =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="keyword">typeof</span> a) <span class="comment">// what should be print?</span></div><div class="line">&#125;, <span class="number">100</span>)</div><div class="line">a = <span class="string">'string'</span></div></pre></td></tr></table></figure>
<p>As a developer, you can easily figure out that <code>string</code> will be output to console because <code>setTimeout</code> will call its function argument asynchronously, after assigning <code>string</code> to <code>a</code>. Unfortunately, this knowledge is not accessible to compiler. No keyword will tell compiler whether callback function will be called <em>immediately</em>, nor static analysis will tell the behavior of a function: <code>setTimeout</code> and <code>forEach</code> is the same in the view of compiler.</p>
<p>So the following example will not compile.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="number">42</span> <span class="comment">// smart cast to number</span></div><div class="line">someArray.forEach(() =&gt; &#123;</div><div class="line">  a.toFixed() <span class="comment">// error, string | number does not have method `toFixed`</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Note: compiler will still inline control flow analysis for <a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE" target="_blank" rel="external">IIFE(Immediately Invoked Function Expression)</a>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> x: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="string">"OK"</span>;</div><div class="line">(() =&gt; &#123;</div><div class="line">  x = <span class="number">10</span>;</div><div class="line">&#125;)();</div><div class="line"><span class="keyword">if</span> (x === <span class="number">10</span>) &#123; <span class="comment">// OK, assignment in IIFE</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In the future, we might have a keyword like <a href="https://github.com/Microsoft/TypeScript/issues/11498" target="_blank" rel="external"><code>immediate</code></a> to help compiler reasoning more about control flow. But that’s a different story.</p>
<p>Now let’s review the strategies for function call.</p>
<h2 id="Optimistic-Flow-Sensitive-Typing"><a href="#Optimistic-Flow-Sensitive-Typing" class="headerlink" title="Optimistic Flow Sensitive Typing"></a>Optimistic Flow Sensitive Typing</h2><p>Optimistic flow typing assume a function without side-effect that changes a variable’s type. TypeScript chooses this strategy in its implementation.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a: <span class="built_in">number</span> | <span class="literal">null</span></div><div class="line">a = <span class="number">42</span> <span class="comment">// assign, now a is narrowed to type `number`</span></div><div class="line">sideEffect() <span class="comment">// assume nothing happens here</span></div><div class="line">a.toFixed() <span class="comment">// a still has `number` type</span></div></pre></td></tr></table></figure>
<p>This assumption usually works well if code observes immutable rule. On the other hand, a stateful program will be tolled with the tax of explicit casting. One typical example is scanner in a compiler. (Both Angular template compiler and TypeScript itself are victims).</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// suppose we are tokenizing an HTML like language</span></div><div class="line"><span class="keyword">enum</span> Token &#123; LeftBracket, WhiteSpace, Letter ... &#125;</div><div class="line"><span class="keyword">let</span> token = Token.WhiteSpace;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">nextToken</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    token = readInput(); <span class="comment">// return a Token</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">scan</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">// token here is WhiteSpace</span></div><div class="line">  <span class="keyword">while</span> (token === Token.WhiteSpace) &#123;</div><div class="line">    <span class="comment">// skip white space, a common scenario</span></div><div class="line">    nextToken()</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (token === Token.LeftBracket) &#123; <span class="comment">// error here</span></div><div class="line">    <span class="comment">// compiler thinks token is still WhiteSpace, optimistically but wrongly</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Such bad behavior also occurs on fields.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A function takes a string and try to parse</span></div><div class="line"><span class="comment">// if success, modify the result parameter to pass result to caller</span></div><div class="line"><span class="keyword">declare</span> <span class="function"><span class="keyword">function</span> <span class="title">tryParse</span>(<span class="params">x: <span class="built_in">string</span>, result: &#123; success: <span class="built_in">boolean</span>; value: <span class="built_in">number</span>; &#125;</span>): <span class="title">void</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params">x: <span class="built_in">string</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> result = &#123; success: <span class="literal">false</span>, value: <span class="number">0</span> &#125;;</div><div class="line"></div><div class="line">    trySomething(x, result);</div><div class="line">    <span class="keyword">if</span> (result.success === <span class="literal">true</span>) &#123; <span class="comment">// error!</span></div><div class="line">        <span class="keyword">return</span> result.value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>An alternative here is returning a new result object so we need no inline mutation. But in some performance sensitive code path might we want parse a string without new object allocation, which reduces garbage collection pressure. After all, mutation is legal in JavaScript code, but TypeScript fails to capture it.</p>
<p>Optimistic flow analysis sometimes is also unsound: a compiler verified program will cause runtime error. We can easily construct a function which reassigns a variable to an object of different type and uses it as of the original type, and thus a runtime error!</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> A &#123; a: <span class="built_in">string</span>&#125;</div><div class="line"><span class="keyword">class</span> B &#123; b: <span class="built_in">string</span>&#125;</div><div class="line"><span class="keyword">let</span> ab: A | B = <span class="keyword">new</span> A</div><div class="line"></div><div class="line">doEvil()</div><div class="line">ab.b.toString() <span class="comment">// booooooom</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doEvil</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  ab = <span class="keyword">new</span> B</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The above examples might leave to you a impression that compiler does much bad when doing optimistic control flow inference. In practice, however, a well architected program with disciplined control of side effect will not suffer much from compiler’s naive optimistism. <a href="https://www.wikiwand.com/en/Presumption_of_innocence" target="_blank" rel="external">Presumption of immutability innocence</a> will save you a lot type casting or variable rebinding found in pessimistic flow sensitive typing.</p>
<h2 id="Pessimistic-Flow-Sensitive-Typing"><a href="#Pessimistic-Flow-Sensitive-Typing" class="headerlink" title="Pessimistic Flow Sensitive Typing"></a>Pessimistic Flow Sensitive Typing</h2><p>A pessimistic flow analysis places <a href="https://www.wikiwand.com/en/Burden_of_proof" target="_blank" rel="external">burden of typing proof</a> on programmers.<br>Every function call will invalidate previous control flow based narrowing. (<em>Pessimistic</em> possibly has a negative connotation, <em>conservative</em> may be a better word here). Thus programmers have to re-prove variable types is matching with previous control flow analysis.</p>
<p>Examples in this section are crafted to be runnable under both TS and flow-type checker.<br>Note, only flow-type checker will produce error because flow is more pessimistic/strict than TypeScript.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">void</span></span></div><div class="line"></div><div class="line"><span class="title">let</span> <span class="title">a</span>: <span class="title">number</span> | <span class="title">string</span> = 42</div><div class="line"></div><div class="line"><span class="title">log</span>(<span class="params">a</span>) // <span class="title">invalidation</span>!</div><div class="line"></div><div class="line"><span class="title">a</span>.<span class="title">toFixed</span>(<span class="params"></span>) // <span class="title">error</span>, <span class="title">a</span>'<span class="title">s</span> <span class="title">type</span> <span class="title">is</span> <span class="title">reverted</span> <span class="title">to</span> `<span class="title">number</span> | <span class="title">string</span>`</div><div class="line"></div><div class="line">// <span class="title">To</span> <span class="title">work</span> <span class="title">around</span> <span class="title">it</span>, <span class="title">you</span> <span class="title">have</span> <span class="title">to</span> <span class="title">recheck</span> <span class="title">the</span> <span class="title">type</span> <span class="title">of</span> `<span class="title">a</span>`</div><div class="line"><span class="title">typeof</span> <span class="title">a</span> === '<span class="title">number</span>' &amp;&amp; <span class="title">a</span>.<span class="title">toFixed</span>(<span class="params"></span>) // <span class="title">works</span></div></pre></td></tr></table></figure>
<p>Alas, pessimistism also breaks fields. Example taken from <a href="http://stackoverflow.com/questions/38531182/weird-method-cannot-be-called-on-possibly-null-undefined-value" target="_blank" rel="external">stackoverflow</a>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="function"><span class="keyword">function</span> <span class="title">assert</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="title">void</span></span></div><div class="line"></div><div class="line"><span class="title">class</span> <span class="title">TreeNode</span>&lt;<span class="title">V</span>, <span class="title">E</span>&gt; &#123;</div><div class="line">    value: V</div><div class="line">    children: Map&lt;E, TreeNode&lt;V,E&gt;&gt; | <span class="literal">null</span></div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>(<span class="params">value: V</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.value = value</div><div class="line">        <span class="keyword">this</span>.children = <span class="literal">null</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">accessChildren</span>(<span class="params">tree: TreeNode&lt;<span class="built_in">number</span>, <span class="built_in">string</span>&gt;</span>): <span class="title">void</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (tree.children != <span class="literal">null</span>) &#123;</div><div class="line">        assert(<span class="literal">true</span>) <span class="comment">// negate type narrowing</span></div><div class="line">        tree.children.forEach((v,k) =&gt; &#123;&#125;) <span class="comment">// error!</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>These false alarms root in the same problem as in optimistic strategy: compiler/checker has no knowledge about a function’s side effect. To work with a pessimistic compiler, one has to assert/check repeatedly so to guarantee no runtime error will occur. Indeed, this is a trade-off between runtime safety and code bloat.</p>
<h2 id="Workaround"><a href="#Workaround" class="headerlink" title="Workaround"></a>Workaround</h2><p>Sadly, no known panacea for flow sensitive typing. We can mitigate the problem by introducing more immutability.</p>
<h3 id="using-const"><a href="#using-const" class="headerlink" title="using const"></a>using <code>const</code></h3><p>Because a <code>const</code> identifier will never change its type.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> a: <span class="built_in">string</span> | <span class="built_in">number</span> = someAPICall() <span class="comment">// smart cast to number</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> a === <span class="string">'string'</span>) &#123;</div><div class="line">  setTimeout(() =&gt; &#123;</div><div class="line">    a.substr(<span class="number">0</span>) <span class="comment">// success, `const` identifier will not lose its narrrowed type</span></div><div class="line">  &#125;, <span class="number">100</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>And using <code>const</code> will provide you runtime safety or bypass pessimistic checker.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">x: <span class="built_in">string</span> | <span class="literal">null</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> y = x</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">assert</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// ... whatever</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (y !== <span class="literal">null</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(y.substr(<span class="number">0</span>)); <span class="comment">// no error, no crash</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The same should apply to <code>readonly</code>, but current TypeScript does not seem to support it.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Flow sensitive typing is an advanced type system feature. Working with control flow analysis smoothly requires programmers to control mutation effectively.</p>
<p>Keeping mutation control in your mind. Flow sensitive typing will not in your way but make a pathway to a safer code base!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/05/how-to-write-copy-paste-friendly-code/" itemprop="url">
                  How to write copy-paste friendly code -- An introductory parody
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-05T00:00:00+08:00" content="2016-11-05">
              2016-11-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/05/how-to-write-copy-paste-friendly-code/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/11/05/how-to-write-copy-paste-friendly-code/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>With the growing population of SOA (<a href="https://www.reddit.com/r/shittyprogramming/comments/4jstef/how_long_does_it_takes_to_master_stack_overflow/" target="_blank" rel="external">StackOverflow</a> <a href="https://twitter.com/divineomega/status/695744177557106688" target="_blank" rel="external">Oriented</a> <a href="https://github.com/drathier/stack-overflow-import" target="_blank" rel="external">Architecture</a>), keeping your code copy-paste friendly is becoming more and more important in demonstrating, developing and question answering.</p>
<p>You want your answer to be available instantly, free of fussy debugging. So copy-paste friendliness is a key property of your code robust enough to be ubiquitously runnable and, eventually, help you gain more reputation.</p>
<p>Adopting copy-paste style is amazing. Copy-paste boosts your productivity by freeing you from rumination on architecture complexity. Your boss will be happy with all the <a href="http://www.itestra.de/fileadmin/Redaktion/Documents/07_itestra_measuring_productivity_using_lines_of_code.pdf" target="_blank" rel="external">SLOC</a> you commit. Your colleagues will respect your absolute ownership of the magnificent, enigmatic, labyrinthine code artifact built by the blob gleaned from everywhere.</p>
<h1 id="1-Always-prefer-“-”-to-strict-equality"><a href="#1-Always-prefer-“-”-to-strict-equality" class="headerlink" title="1. Always prefer “==” to strict equality."></a>1. Always prefer “==” to strict equality.</h1><p>Implicit conversion grants you additional robustness. Your code will never complain about ill input. Copy-paste without worry. Yeah</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x = <span class="string">'10'</span></div><div class="line"><span class="keyword">if</span> (x == <span class="number">10</span>) x += <span class="number">5</span></div><div class="line">y = x / <span class="number">5</span> <span class="comment">// wow, it works!</span></div></pre></td></tr></table></figure>
<p>And you can enjoy this artistic <a href="https://dorey.github.io/JavaScript-Equality-Table/" target="_blank" rel="external">equality table</a> when debugging. Cool.<br><img src="/images/comparison.png"></p>
<h2 id="2-Always-prefer-positive-condition"><a href="#2-Always-prefer-positive-condition" class="headerlink" title="2. Always prefer positive condition."></a>2. Always prefer positive condition.</h2><p>Never return early on invalid case. You can copy-paste it any where in your control flow. Yeah.</p>
<p>If <code>return</code> is added, you have to remove the unnecessary control flow abrupting keyword when you need to copy paste these code into a deeply nested code block, which is quite common in CPS(copy-paste-style) programming.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">someFunction</span>(<span class="params">someCondition</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (someCondition) &#123;</div><div class="line">    <span class="comment">// Do whatever you want</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-Always-prefer-tautological-check"><a href="#3-Always-prefer-tautological-check" class="headerlink" title="3. Always prefer tautological check."></a>3. Always prefer tautological check.</h2><p>Repetition here is for genericity. Every conditional path can be copy-pasted free of reading. They are very safe compile time constructs that preclude the very possibility of runtime <code>undefined</code> panic.</p>
<p><code>else</code> on individual line is a bonus. You can copy-and paste code without looking at <code>else</code> keyword! What a profit!</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (a &amp;&amp; a.b &amp;&amp; a.b.c == <span class="number">1</span>) &#123;</div><div class="line">  <span class="comment">// never worried about a.b.c is not undefined</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="keyword">if</span> (a &amp;&amp; a.b &amp;&amp; a.b.c == <span class="number">2</span>) &#123;</div><div class="line">  <span class="comment">// repition is one aesthetic rule</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="keyword">if</span> (a &amp;&amp; a.b &amp;&amp; a.b.c == <span class="number">3</span>) &#123;</div><div class="line">  <span class="comment">// very safe even programmer inadvertedly paste it to elsewhere</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-Always-prefer-fully-qualified-name"><a href="#4-Always-prefer-fully-qualified-name" class="headerlink" title="4. Always prefer fully qualified name"></a>4. Always prefer fully qualified name</h2><p>Never cache common subexpression. Declaring new variable name will force you read code and find declaration before copy-pasting.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">topVariable.someProperty.nestedProp.anotherProp = <span class="number">123</span></div><div class="line"><span class="built_in">console</span>.log(topVariable.someProperty.nestedProp.anotherProp)</div><div class="line">topVariable.someProperty.nestedProp.anotherProp += <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="5-Always-prefer-inlining-statements-in-function"><a href="#5-Always-prefer-inlining-statements-in-function" class="headerlink" title="5. Always prefer inlining statements in function"></a>5. Always prefer inlining statements in function</h2><p>Never factor out functions. Helpers require nonlocal function name lookup when copy-pasting. Dev experience terminator.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Oh, GG. I forgot GitHub Gists!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/01/how-to-choose-vue-library/" itemprop="url">
                  Compare TypeScript libraries for Vue -- a review
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-01T00:00:00+08:00" content="2016-11-01">
              2016-11-01
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/01/how-to-choose-vue-library/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/11/01/how-to-choose-vue-library/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Vue has a lot of TypeScript  binding libraries. A lot of.</p>
<p>They look similar, with subtle difference. How to choose one?</p>
<p>Here I compare three libraries.</p>
<ul>
<li><a href="https://libraries.io/npm/vue-typescript-component" target="_blank" rel="external">vue-typescript-component</a></li>
<li><a href="https://github.com/vuets/vuets" target="_blank" rel="external">vuets</a></li>
<li><a href="https://github.com/HerringtonDarkholme/av-ts/" target="_blank" rel="external">av-ts</a></li>
</ul>
<p>They are representative, and the analysis probably also applies to the <a href="https://github.com/vuejs/vue-class-component" target="_blank" rel="external">official library</a>.</p>
<blockquote>
<p>Disclaimer: I’m the author of av-ts. So this article is probably biased. But I tried my best to give an objective review.</p>
</blockquote>
<h3 id="0-Overview"><a href="#0-Overview" class="headerlink" title="0. Overview"></a>0. Overview</h3><p>Vue-typescript-component and av-ts are decorator based libraries. Vue-typescript-component is more like the popular typescript <a href="https://github.com/itsFrank/vue-typescript" target="_blank" rel="external">library</a>, but supports Vue2.0. av-ts is my own library, crated after I read many alternatives.<br>vuets is quite different. It resembles the original object literal style API from vue.js.<br>Before I start the review, I want to state a rule of thumb before.</p>
<blockquote>
<p>The more flexiblity a library boasts, the harder for a type checker to verify it.</p>
</blockquote>
<p>It is quite common in programming world. For example, JavaScript is very flexible and dynamic, but it is usually hard to determine whether a property access is legal. Java is a static language, <code>javac</code> can help you check many pernicious typos in code, but Java cannot easily do reflective programming.</p>
<p>Vue has a very flexible and elegant API, but it comes <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">at the cost of type safety</a>. That’s why all these Vue TypeScript libraries exist. How to balance between expressiveness and type safety is the main concern of such a library.</p>
<h3 id="1-Compatibility"><a href="#1-Compatibility" class="headerlink" title="1. Compatibility"></a>1. Compatibility</h3><p>All the three libraries, vue-typescript-component, vuets and av-ts, have good support for Vue2 and TS2. So there is not much to compare here. (vuets has vue1.0 support while the other two do not)</p>
<h3 id="2-Extensibility"><a href="#2-Extensibility" class="headerlink" title="2. Extensibility"></a>2. Extensibility</h3><p>I think this is the best part of av-ts. av-ts provides a <code>Component.register</code> for custom decorator. For example, if you want to use vuex in your project but also want to preserve type safety, you can create your own decorator. This is exactly what I do in <a href="https://github.com/HerringtonDarkholme/kilimanjaro" target="_blank" rel="external">kilimanjaro</a>, a typed vuex fork.<br>vue-ts-copmonent does not provide extensibility at all. vue-ts has the same extensibility as original vue because it uses object literal style (that is, the most extensible one among the three). However, vuets also support class component like syntax. Mixing two style is somewhat confusing.</p>
<h3 id="3-Idiom"><a href="#3-Idiom" class="headerlink" title="3. Idiom"></a>3. Idiom</h3><p>av-ts and vue-ts-component are both idiomatic TypeScript code. class/property/component just feel like plain-old-typescript. vue-ts chooses object literal style API. While it looks the most similar to original vue, it is not as idiomatic as the other two in TypeScript land. Also, object literal style requires many manual typing annotation, which feels foreign to both JavaScript and TypeScript.</p>
<h3 id="4-Conciseness"><a href="#4-Conciseness" class="headerlink" title="4.Conciseness"></a>4.Conciseness</h3><p>vue-ts is the most verbose as mentioned above. Object literal style API is almost impossible to have good type inference for contemporary compilers. You can read more about it <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">here</a>. Basically I don’t think vue-ts is an ideal approach.<br>av-ts and vue-ts-component are concise. Most methods/properties require only annotating once. av-ts requires more decorators for special methods like render and lifecycle, while it has a more concise and type safe property syntax. So I think this is a tie.</p>
<h3 id="5-Type-Safety"><a href="#5-Type-Safety" class="headerlink" title="5. Type Safety"></a>5. Type Safety</h3><p>av-ts and vue-ts-component can inject Vue’s native types by <code>extends Vue</code>. Neat. vuets users have to re-annotate all the method again, <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">alas</a>. av-ts has more type safety when defining special methods like <code>render</code>, <code>lifecycle</code> and <code>transition</code>. This is powerer by new decorators introduced. Again, these decorators are created by <code>Component.register</code> and the implementation is not hard-coded into one file.</p>
<h3 id="6-Expressiveness"><a href="#6-Expressiveness" class="headerlink" title="6. Expressiveness"></a>6. Expressiveness</h3><p>vuets is as expressive as original vue, at the cost of more annotation. vue-ts-component can express most basic API in vue, but there is something it cannot. av-ts can use <a href="https://github.com/HerringtonDarkholme/av-ts#mixin" target="_blank" rel="external">mixin</a> and can <a href="https://github.com/HerringtonDarkholme/av-ts#data" target="_blank" rel="external">use props in data method</a>. I have thought over these scenarios before hand.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>av-ts may not be the best component library for vue, but I believe it strikes the sweet point between conciseness, type safety and expressiveness. I’m happy to see more TS+Vue users try it out, and give me feedback so it can become better.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/03/vue2-ts2/" itemprop="url">
                  Vue2 + TypeScript2 -- an introductory guide
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-03T00:00:00+08:00" content="2016-10-03">
              2016-10-03
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/03/vue2-ts2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/03/vue2-ts2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Safety check and error detection are important to development experience. Vue has gone to <a href="https://github.com/vuejs/vue/issues/3831#issuecomment-250996462" target="_blank" rel="external">great lengths</a> to provide <a href="https://github.com/vuejs/vue/pull/3656" target="_blank" rel="external">component information</a> when typos or mistakes happen. But we can do better, error reporting can happen at compile time. This is why we want to use TypeScript with Vue.</p>
<p><img src="https://github.com/HerringtonDarkholme/vue-ts-example/raw/master/screen.png" alt="final result"></p>
<blockquote>
<p>Our goal: writing Vue in TypeScript</p>
</blockquote>
<h2 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h2><p>In this guide we will finally achieve these goals:</p>
<ul>
<li>writing type safe vue instance declaration</li>
<li>writing TypeScript in Vue’s <a href="https://vuejs.org/guide/single-file-components.html" target="_blank" rel="external">single file component</a></li>
<li>semantic completion in pure TypeScript file</li>
<li>type checking all TypeScript, even TypeScript in <code>*.vue</code>‘s script tag.</li>
</ul>
<blockquote>
<p>All code example can be found <a href="https://github.com/HerringtonDarkholme/vue-ts-example" target="_blank" rel="external">here</a>, with separte commits standing for sections in this article.</p>
</blockquote>
<h2 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h2><p>You have to know about TypeScript2.0 and Vue2.0. And optionally webpack’s knowledge is very useful. And of course if you’re reading this article you must have known <code>npm</code>.</p>
<h2 id="Basic-setup"><a href="#Basic-setup" class="headerlink" title="Basic setup:"></a>Basic setup:</h2><p>First make a new directory for your project. And then init your new project and install dependencies.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir vue-ts-test</div><div class="line"><span class="built_in">cd</span> vue-ts-test</div><div class="line">npm init</div><div class="line"><span class="comment"># pressing `enter`s and done</span></div><div class="line">npm install vue --save</div><div class="line">npm install typescript --save</div></pre></td></tr></table></figure>
<p>Note both vue and TypeScript need to be version 2. They have both definition files baked in so it’s much easier to start up with them than before. (I still respect definitely typed!)</p>
<p>make html template, say, <code>index.html</code>:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"node_modules/vue/dist/vue.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"app.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Then in your <code>app.ts</code>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">var</span> Vue: <span class="built_in">any</span></div><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">'#app'</span>,</div><div class="line">  render(h) &#123;</div><div class="line">    <span class="keyword">return</span> h(<span class="string">'h1'</span>, <span class="string">'hello world'</span>)</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>And compile your code:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./node_modules/.bin/tsc app.ts</div></pre></td></tr></table></figure></p>
<p>Then open <code>index.html</code> in your browswer! It should give you a hello world!</p>
<h2 id="Exploring-Vue-with-TypeScript"><a href="#Exploring-Vue-with-TypeScript" class="headerlink" title="Exploring Vue with TypeScript"></a>Exploring Vue with TypeScript</h2><p>But there are a lot of feature missing in the above example. For example, you want a build step to combine all your scripts. You want component style co-locates with template and script, yet still sytnax highlighting  every thing.</p>
<p>Let’s use Vue’s genius single file component. It requires <a href="https://webpack.github.io/" target="_blank" rel="external">webpack</a> and <a href="http://vue-loader.vuejs.org/en/index.html" target="_blank" rel="external">vue-loader</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install webpack --save-dev</div><div class="line">npm install vue-loader --save-dev</div><div class="line">npm install css-loader --save-dev</div></pre></td></tr></table></figure>
<p>Or you can use <a href="https://github.com/vuejs/vue-cli" target="_blank" rel="external">vue-cli</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vue init webpack-simple vue-ts-test</div></pre></td></tr></table></figure>
<p>You need to make vue-loader to transpile your TypeScript code. <a href="https://github.com/HerringtonDarkholme/vue-ts-loader" target="_blank" rel="external">vue-ts-loader</a> can work with vue-loader.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install vue-ts-loader --save-dev</div></pre></td></tr></table></figure>
<p>And in <code>webpack.config.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">    <span class="attr">entry</span>: &#123; <span class="attr">app</span>: <span class="string">'./app.ts'</span>, &#125;,</div><div class="line">    <span class="attr">output</span>: &#123; <span class="attr">filename</span>: <span class="string">'app.js'</span> &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// resolve TypeScript and Vue file</span></div><div class="line">    resolve: &#123;</div><div class="line">        <span class="attr">extensions</span>: [<span class="string">''</span>, <span class="string">'.ts'</span>, <span class="string">'.vue'</span>, <span class="string">'.js'</span>]</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">module</span>: &#123;</div><div class="line">        <span class="attr">loaders</span>: [</div><div class="line">            &#123; <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>, <span class="attr">loader</span>: <span class="string">'vue'</span> &#125;,</div><div class="line">            &#123; <span class="attr">test</span>: <span class="regexp">/\.ts$/</span>, <span class="attr">loader</span>: <span class="string">'vue-ts'</span> &#125;</div><div class="line">        ],</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">vue</span>: &#123;</div><div class="line">      <span class="comment">// instruct vue-loader to load TypeScript</span></div><div class="line">      loaders: &#123; <span class="attr">js</span>: <span class="string">'vue-ts-loader'</span>, &#125;,</div><div class="line">      <span class="comment">// make TS' generated code cooperate with vue-loader</span></div><div class="line">      esModule: <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now you can add write Vue code in single file component!</p>
<p>Suppose in <code>app.vue</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span> @<span class="attr">click</span>=<span class="string">"hello"</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</div><div class="line">  <span class="attr">methods</span>: &#123;</div><div class="line">    <span class="comment">// type annotation!</span></div><div class="line">    hello(): <span class="keyword">void</span> &#123;</div><div class="line">      alert(<span class="string">'hello world'</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>And now you can change your <code>app.ts</code> into an entry file.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">var</span> <span class="built_in">require</span>: <span class="built_in">any</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> Vue = <span class="built_in">require</span>(<span class="string">'vue'</span>)</div><div class="line"><span class="keyword">var</span> App = <span class="built_in">require</span>(<span class="string">'./app.vue'</span>).default</div><div class="line"></div><div class="line"><span class="keyword">new</span> Vue(&#123;</div><div class="line">  el: <span class="string">'#app'</span>,</div><div class="line">  components: &#123; App &#125;,</div><div class="line">  render: h =&gt; h(<span class="string">'app'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Now <code>webpack</code> your in your application directory. You can still see the <code>hello world</code>? Click it should give you an alert.</p>
<p>Cool? And here is the <a href="https://github.com/HerringtonDarkholme/vue-ts-example/tree/f3d0d409d9b5de8b6f20b5a06b156b7313703475" target="_blank" rel="external">source</a>.</p>
<h2 id="Toward-a-more-type-safe-API"><a href="#Toward-a-more-type-safe-API" class="headerlink" title="Toward a more type safe API"></a>Toward a more type safe API</h2><p>Vue has a <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">typechecker hostile API</a>.<br>We can use helper library to get a better type checking. <a href="https://github.com/HerringtonDarkholme/av-ts" target="_blank" rel="external">av-ts</a>, Awesome Vue for TypeScript, is a good start point to use.</p>
<p>Install it by npm, again.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --save av-ts</div></pre></td></tr></table></figure></p>
<p>Then you can change your <code>app.vue</code> to this.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">h1</span> @<span class="attr">click</span>=<span class="string">"hello"</span>&gt;</span>hello &#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line"><span class="comment">// import dependency</span></div><div class="line"><span class="keyword">import</span> &#123;Vue, Component&#125; <span class="keyword">from</span> <span class="string">'av-ts'</span></div><div class="line"></div><div class="line"><span class="comment">// decorat vue class</span></div><div class="line">@Component</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Vue</span> </span>&#123;</div><div class="line">  <span class="comment">// undecorated property will be packed in `data` option</span></div><div class="line">  name = <span class="string">'world'</span></div><div class="line">  <span class="comment">// undecorated method is just method</span></div><div class="line">  hello() &#123;</div><div class="line">    alert(<span class="string">'hello '</span> + <span class="keyword">this</span>.name)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>webpack</code> will give you an error. Because decorator is still considered experimental. You need to switch it on explicitly.</p>
<p>Add a <code>tsconfig.json</code> in your directory.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"compilerOptions"</span>: &#123;</div><div class="line">        <span class="attr">"module"</span>: <span class="string">"commonjs"</span>,</div><div class="line">        <span class="attr">"target"</span>: <span class="string">"es5"</span>,</div><div class="line">        <span class="attr">"experimentalDecorators"</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now it compiles! Check it out in browser!</p>
<p>av-ts has several features that isn’t present in other libraries.<br>First, <code>prop</code> is defined in class, so you can access these as properties in other methods without declaring in class again. Second, <code>data</code>, <code>render</code> and lifecycle hooks are declared by decorator, which is a mark to tell you these methods are different. Plus, their names and signatures can be checked by decorators. Third, extension is easy in av-ts. You can register new decorator, and still keep type safety.</p>
<p>For source as a whole, you can take a look <a href="https://github.com/HerringtonDarkholme/vue-ts-example/tree/2609c7c754379c86788bb7bf515eb001989c0b6a" target="_blank" rel="external">here</a>.</p>
<h2 id="Even-more-typesafety"><a href="#Even-more-typesafety" class="headerlink" title="Even more typesafety"></a>Even more typesafety</h2><p><a href="http://vuex.vuejs.org/en/index.html" target="_blank" rel="external">Vuex</a> is another popular state management library for vue.</p>
<p><a href="https://github.com/HerringtonDarkholme/kilimanjaro" target="_blank" rel="external">Kilimanjaro</a> is a type safe fork for Vuex.</p>
<p>To create a store is familiar with its original API.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; create &#125; from <span class="string">'kilimanjaro'</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> store =</div><div class="line">  create(&#123;count: <span class="number">0</span>&#125;) <span class="comment">// create a state with initial state</span></div><div class="line">  .getter(<span class="string">'count'</span>, s =&gt; s.count) <span class="comment">// a getter</span></div><div class="line">  .mutation(<span class="string">'increment'</span>, s =&gt; () =&gt; s.count++) <span class="comment">// define a mutation</span></div><div class="line">  .mutation(<span class="string">'decrement'</span>, s =&gt; () =&gt; s.count--) <span class="comment">// payload is in the second parameter parenthesis</span></div><div class="line">  .done()</div><div class="line"></div><div class="line">store.commit(<span class="string">'increment'</span>) <span class="comment">// make a state change</span></div><div class="line"><span class="comment">// store.commit('ncrement') // typo won't compile! magic!</span></div></pre></td></tr></table></figure>
<p>By heavy use of string literal type and overloading, kilimanjaro provides a similiar type safe API to vuex.<br>If you mistakenly commit a wrong mutation name, or the mutation payload does not have correct type, kilimanjaro will make TypeScript compiler report that for you.</p>
<p>There is also component helper in kilimanjaro. Check the example below</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;Vuex, getHelper&#125; from <span class="string">'kilimanjaro'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> &#123; getters, commit &#125; = getHelper(store)</div><div class="line"></div><div class="line"><span class="meta">@Componet</span></div><div class="line"><span class="keyword">class</span> App extends Vue &#123;</div><div class="line">  <span class="meta">@Vuex</span> count: <span class="built_in">number</span> = getters(<span class="string">'count'</span>)</div><div class="line">  <span class="meta">@Vuex</span> add: <span class="built_in">Function</span> = commit(<span class="string">'increment'</span>)</div><div class="line">  <span class="comment">// @Vuex typo: Function = commit('ncrement') // won't compile</span></div><div class="line">  <span class="comment">// @Vuex wrong: string = getters('count') // type incompatible</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can get component helpers by calling <code>getHelper</code>. Helpers are function that take a getter/mutation/action name and return corresponding result. Given a mutation name, <code>commit</code> helper will return a function that, once called, changes store state. The similiar for <code>dispatch</code> helper.</p>
<p><code>getters</code> is more magical. Given a getter name, it will return a <em>symbol</em> with correct result type. But at runtime, it will be changed to a <code>computed</code> accessor in the VM. The magic is done by the <code>Vuex</code> decorator, which is an extension of <code>av-ts</code>. Like mentioned above, av-ts is a very extensible library.</p>
<blockquote>
<p>For a working example, you can take a look <a href="https://github.com/HerringtonDarkholme/vue-ts-example" target="_blank" rel="external">here</a>. And <a href="https://herringtondarkholme.github.io/vue-ts-example/">Live demo</a> is here.</p>
</blockquote>
<p>Vue-router is type safe enough for pragmatic usage. It is really a well written and designed library. Designing a library that provides 100% type safety is just an overkill bringing marginal benefits at huge cost of debugging compiling error.<br>If vue-router cannot cater for a type paranoid, this <a href="https://github.com/HerringtonDarkholme/paranoid-router" target="_blank" rel="external">sketch</a> will be interesting.</p>
<h2 id="Limitation"><a href="#Limitation" class="headerlink" title="Limitation"></a>Limitation</h2><p>You might want even more features from TypeScript, say</p>
<ul>
<li>semantic completion in single file component</li>
<li>type checking template code</li>
</ul>
<p><img src="https://s-media-cache-ak0.pinimg.com/originals/86/72/e6/8672e6fb04620cbcf72ab3b1222ae5b5.jpg" alt="go home, you&#39;re drunk"></p>
<p>They are way way hard to implement. Semantic completion in <code>vue</code> file requires editor support and <a href="https://github.com/Microsoft/TypeScript/pull/10160" target="_blank" rel="external">compiler support</a>. None of them is easy to implement.</p>
<p>You can write your vm code in a separate file and import into your vue template. But that is opposite to the design philosophy of single file component. In reality, keeping <code>vue</code> small and clean is better choice. With small number of symbols in source file, generic completion should also work well. (at least as well as plain JavaScript)</p>
<p>Template code is an even more heculean task. Vue compiles its template into <code>with(this) { ... }</code> format (<a href="http://vuejs.org/guide/render-function.html" target="_blank" rel="external">doc</a>). <code>with</code> statements are not checked in TypeScript, nor flow-type. Plus, vue compiler does analyze no expression, making it impossible to do checking without reimplementing a compiler. However, again, it is no worse than plain JavaScript.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Vue is an elegant and lightweight library. With the integration of TypeScript, Vue can be more safe and productive!</p>
<p>Compared to other frameworks, you can instantly get precompiled template code, small code footprint, flat learning curve.<br>But when it comes to scale bigger, you might want additional help.</p>
<p>There are overhead to integrate TypeScript with Vue, indeed. But the error checking and refactoring help still worth your try.</p>
<p>Tools we used to achieve type-safety</p>
<ul>
<li>TypeScript2 and Vue2, for their definition files</li>
<li><a href="https://github.com/HerringtonDarkholme/vue-ts-loader" target="_blank" rel="external">vue-ts-loader</a>: load TypeScript in vue’s single file component</li>
<li><a href="https://github.com/HerringtonDarkholme/av-ts" target="_blank" rel="external">av-ts</a>: wrap vue’s API in type safe way</li>
</ul>
<p>Optionally</p>
<ul>
<li><a href="https://github.com/HerringtonDarkholme/kilimanjaro" target="_blank" rel="external">kilimanjaro</a>: type safe vuex, requires deeper understanding of TypeScript’s advanced features.</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/02/vue-router/" itemprop="url">
                  Type Safe Routing for Vue.js
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-02T00:00:00+08:00" content="2016-10-02">
              2016-10-02
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/02/vue-router/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/02/vue-router/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Vue router is elegant and type safe enough for most use cases. But I want to experiment how far typescript can help us.</p>
<p>Typesafe routing isn’t easy to do.</p>
<p>The easiest way to declare multiple class and instantatiate their paramater type. For example, <a href="https://github.com/angryzor/typesafe-urls" target="_blank" rel="external">typed-url</a>. But this is too verbose.</p>
<p>Another approach is to use functional <strong>combinator</strong>. To put it simple, combinator is high order function that can abstract various operation. Routing combinators usually are a bunch of functions that can accept strings as static url segment or a function as dynamic url parameter. Both <a href="https://github.com/slamdata/purescript-routing/blob/master/GUIDE.md" target="_blank" rel="external">purescript</a> and <a href="https://speakerdeck.com/inamiy/type-safe-url-routing-in-swift" target="_blank" rel="external">swift</a>. But monad is too monad-y. My head just explodes.</p>
<p>One unique way to provide type routing is using reified generic! A demo <a href="https://vimeo.com/172310206" target="_blank" rel="external">video</a> has illustrted how to implment it.(Spoiler: for a function with type <code>A =&gt; Response</code>, one can access the class by  <code>A.type</code> and cast value by <code>guard let param: A = ....</code> in swift. Whoa, reification is powerful). Github repo is here: <a href="https://github.com/NougatFramework/Switchboard" target="_blank" rel="external">https://github.com/NougatFramework/Switchboard</a></p>
<p>Compile time reflection is ideal for routing thing. Yesod uses template haskell to do this, <a href="https://github.com/AndrewRademacher/routing-comparison/blob/master/yesod-test/src/Main.hs" target="_blank" rel="external">Example</a>. Macro paradise!</p>
<p>Scala has yet another unique construct called pattern match.  Tumblr’s <a href="https://tumblr.github.io/colossus/" target="_blank" rel="external">colossus</a> is a great example to use pattern match for type safe routing.</p>
<p>And of course, haskell has many type safe routing library. Check out the <a href="https://github.com/scotty-web/scotty/issues/60" target="_blank" rel="external">review</a> for more info.</p>
<p>JavaScript does not have powerful constructs like macro/pattern match. Combinator is the only way to achieve type safety but for client side component based routing, declaring more functions solely for routing doesn’t feel natural. And specifically TypeScript is still too feeble to describe routing. However, by combining tagged template, function overloading (or fun-dep), and intersection type (or row polymorphism), we can still do some interesting thing. If this were written in flow-type, more interesting thing could happen.</p>
<p>Frankly type safety in router does not grant you much: it cannot check tempalte code, it can only help you to double check the shape of parameters in <code>$route</code>. It can help you to type <code>router</code> instance better, but requires all routes to have a <code>name</code> field.</p>
<p>This is only a sketch for type safe routing design. Useful? No. Concise? Partly. Safety outweighs ease of use? No. Maybe it’s only suitable for type safe paranoid.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span> Route&lt;T&gt; &#123;</div><div class="line">  &lt;K extends <span class="built_in">string</span>, C&gt;(c: StaticRouteConfig&lt;K, C&gt;): Routes&lt;StaticRouteAct&lt;K&gt; &amp; C &amp; T&gt;</div><div class="line">  &lt;K extends <span class="built_in">string</span>, R, P extends R, C&gt;(c: RouteConfig&lt;K, R, P, C&gt;): Routes&lt;RouteAct&lt;K, P&gt; &amp; C &amp; T&gt;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> StaticRouteAct&lt;K&gt; &#123;</div><div class="line">  (location: &#123;name: K&#125;): <span class="built_in">void</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> RouteAct&lt;K, T&gt; &#123;</div><div class="line">  (location: &#123;name: K, params: T&#125;): <span class="built_in">void</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> Router&lt;T&gt; &#123;</div><div class="line">  push: T</div><div class="line">  replace: T</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> Routes&lt;T&gt; &#123;</div><div class="line">  route: Route&lt;T&gt;</div><div class="line">  done: () =&gt; Router&lt;T&gt;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> StaticRouteConfig&lt;K <span class="keyword">extends</span> string, C&gt; &#123;</div><div class="line">  name: K</div><div class="line">  path: StaticPath,</div><div class="line">  children?: (p: OriginPath) =&gt; Routes&lt;C&gt;</div><div class="line">  component?: &#123;$routes?: &#123;params?: &#123;&#125;&#125;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> RouteConfig&lt;K <span class="keyword">extends</span> string, R, P <span class="keyword">extends</span> R, C&gt;&#123;</div><div class="line">  name: K</div><div class="line">  path: Path&lt;P&gt;,</div><div class="line">  children?: (p: PathMaker&lt;P&gt;) =&gt; Routes&lt;C&gt;</div><div class="line">  component?: &#123;$routes?: &#123;params?: R&#125;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> Path&lt;T&gt; &#123;</div><div class="line">  __pathBrand: T</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> StaticPath <span class="keyword">extends</span> Path&lt;&#123;&#125;&gt; &#123;</div><div class="line">  __staticPathBrand: never</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> PathMaker&lt;Parent&gt; &#123;</div><div class="line">  &lt;A, B&gt;(t: TemplateStringsArray, n: A, n2: B): Path&lt;A &amp; B &amp; Parent&gt;</div><div class="line">  &lt;A&gt;(t: TemplateStringsArray, n: A): Path&lt;A &amp; Parent&gt;</div><div class="line">  (t: TemplateStringsArray): Path&lt;Parent&gt;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">interface</span> OriginPath &#123;</div><div class="line">  __originPathBrand: never</div><div class="line">  &lt;A, B&gt;(t: TemplateStringsArray, n: A, n2: B): Path&lt;A &amp; B&gt;</div><div class="line">  &lt;A&gt;(t: TemplateStringsArray, n: A): Path&lt;A&gt;</div><div class="line">  (t: TemplateStringsArray): StaticPath</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> UserComponent =  &#123;$routes: &#123;params: &#123; uid: <span class="string">'333'</span>&#125;&#125;&#125;</div><div class="line"><span class="keyword">const</span> unimplement: never = <span class="literal">null</span> as never</div><div class="line"><span class="keyword">const</span> route: Route&lt;never&gt; = unimplement</div><div class="line"><span class="keyword">const</span> p: OriginPath = unimplement</div><div class="line"></div><div class="line"><span class="keyword">const</span> rs =</div><div class="line">route(&#123;</div><div class="line">  path: p<span class="string">`user/<span class="subst">$&#123;&#123;uid: ''&#125;</span>&#125;/profile/<span class="subst">$&#123;&#123;pageType: ''&#125;</span>&#125;`</span>,</div><div class="line">  name: <span class="string">'user'</span>,</div><div class="line">  component: UserComponent,</div><div class="line">  children: p =&gt; route(&#123;</div><div class="line">    name: <span class="string">'tab'</span>,</div><div class="line">    path: p<span class="string">`tab/<span class="subst">$&#123;&#123;tab: ''&#125;</span>&#125;`</span>,</div><div class="line">    component: &#123;$routes: &#123;params: &#123;uid: <span class="string">'123'</span>, tab: <span class="string">'333'</span>&#125;&#125;&#125;,</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line">.route(&#123;</div><div class="line">  path: p<span class="string">`post`</span>,</div><div class="line">  name: <span class="string">'post'</span></div><div class="line">&#125;)</div><div class="line">.done()</div><div class="line"></div><div class="line">rs.push(&#123;name: <span class="string">'post'</span>&#125;)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/21/vue-ts/" itemprop="url">
                  Type Safety in Vue.js
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-21T00:00:00+08:00" content="2016-08-21">
              2016-08-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/21/vue-ts/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/21/vue-ts/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Static typing has become a hot word in frontend land: hundreds of tweets and blogs appears on social network and <em>XXXX weekly</em>, rivaling type checkers compete their features with each other.</p>
<p>Correspondingly new frameworks have a consciousness of type safety in their API design.<br><a href="https://angular.io/" target="_blank" rel="external">Angular2</a> has partial type safety in ViewModel code notwithstanding template code. (There has been <a href="https://github.com/Microsoft/TypeScript/issues/6508" target="_blank" rel="external">some efforts</a> to pursue more type safety, though)</p>
<p><a href="https://facebook.github.io/react/index.html" target="_blank" rel="external">React</a> has full, and strict, when checked with <a href="https://flowtype.org/docs/react.html" target="_blank" rel="external">flow</a>, type safety by embedding templates in JavaScript(X).</p>
<p>But stakeholders of <a href="https://rc.vuejs.org/" target="_blank" rel="external">Vue.js</a>, <del>the thirdwhee..</del> another popular MVVM framework , might be disappointed by Vue’s type-checker hostility…</p>
<h2 id="Type-Checker-Hostile-API"><a href="#Type-Checker-Hostile-API" class="headerlink" title="Type Checker Hostile API"></a>Type Checker Hostile API</h2><p>Vue provides a set of simple and elegant <a href="https://rc.vuejs.org/api/" target="_blank" rel="external">API</a> via heavy use of reflection that extinguishes compiler’s type inference.</p>
<p>It’s not Vue’s fault. Up to now static type checkers in JavaScript land have several limitations:</p>
<ol>
<li>They cannot understand modification to objects’ type or perform key-wise type inference. (more elaboration later)</li>
<li>Some cannot annotate function’s <code>this</code> type. (not in <a href="https://github.com/facebook/flow/issues/452" target="_blank" rel="external">flowtype 0.30</a>, supported in TypeScript)</li>
<li>Some cannot annotate <a href="https://github.com/Microsoft/TypeScript/issues/1295" target="_blank" rel="external">Type Property Type</a>. (not in TypeScript until <a href="https://github.com/Microsoft/TypeScript/pull/10425" target="_blank" rel="external">#10425</a> is merged, <a href="https://github.com/facebook/flow/blob/master/src/typing/type_annotation.ml" target="_blank" rel="external">flowtype</a> has <a href="http://sitr.us/2015/05/31/advanced-features-in-flow.html" target="_blank" rel="external">undocumented $Magic</a> type like <a href="https://github.com/facebook/flow/blob/master/lib/react.js#L49" target="_blank" rel="external">$Keys</a>, $Record)</li>
</ol>
<p>For point1, an example will elucidate itself.</p>
<p>Suppose we are going to provide a type definition file for Vue’s <a href="https://rc.vuejs.org/api/#Options-Data" target="_blank" rel="external">config option</a>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">interface</span> VueConfig&lt;D, P, PD, C, M, W&gt; &#123;</div><div class="line">  data?: D</div><div class="line">  props?: P</div><div class="line">  propData?: PD</div><div class="line">  computed?: C &amp; &#123;[k: <span class="built_in">string</span>]: (<span class="keyword">this</span>:D &amp; P &amp; C &amp; M ) =&gt; &#123;&#125;&#125;</div><div class="line">  methods?: M &amp; &#123;[k: <span class="built_in">string</span>]: (<span class="keyword">this</span>:D &amp; P &amp; C &amp; M) =&gt; &#123;&#125;&#125;</div><div class="line">  watch?: W &amp; &#123;[k: <span class="built_in">string</span>]: (<span class="keyword">this</span>:D &amp; P &amp; C &amp; M) =&gt; &#123;&#125;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This is not very precise but does highlight some basic idea of Vue’s API. <code>computed</code> is a field of which the value is a function with <code>this</code> pointed to the object that has mixed in <code>data</code>, <code>props</code> and <code>method</code>. <code>this</code> in Vue’s option is an object made out of reflection.</p>
<p>Then we will write some function like this.<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getVue</span>&lt;<span class="title">D</span>, <span class="title">P</span>, <span class="title">PD</span>, <span class="title">C</span>, <span class="title">M</span>, <span class="title">W</span>&gt;(<span class="params">opt: VueConfig&lt;D, P, PD, C, M, W&gt;</span>): <span class="title">D</span> &amp; <span class="title">P</span> &amp; <span class="title">C</span> &amp; <span class="title">M</span></span></div><div class="line">  &#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">null</span> <span class="comment">// placeholder</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> a = getVueConfig(&#123;</div><div class="line">  data: &#123;</div><div class="line">    a: <span class="number">123</span>,</div><div class="line">  &#125;,</div><div class="line">  watch: &#123;</div><div class="line">    a: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.a) <span class="comment">// oops</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>Compiler will complain about <code>this.a</code> in the watch function. Why? <code>this</code> cannot be inferred. To infer <code>this</code>, compiler will have to first infer <code>D, P, C, M</code> respectively. To infer <code>D &amp; P &amp; C &amp; M</code>, compiler will have to first infer the whole expression for resolving all the type arguments. But to infer the whole expression we need first infer <code>watch</code>, where we need to infer <code>this</code>. So comes a recursion. Compiler cannot be too eager to infer type otherwise it will jump into a recursion trap. Sloth is a virtue here, even <a href="http://rezero.wikia.com/wiki/Petelgeuse_Romanee-Conti" target="_blank" rel="external">Betelgeuse</a> cannot blame.</p>
<h2 id="Alternative-API"><a href="#Alternative-API" class="headerlink" title="Alternative API"></a>Alternative API</h2><p>Vue’s original API is doomed to be hard to infer. However, we can build a thin layer of wrapper to leverage type checkers.</p>
<p>I have two alternatives to present here. One is chaining DSL, a novel approach to induct type checking and inference into Vue. The other alternative is more established and angular like: class decorator.</p>
<h2 id="Chaining-DSL"><a href="#Chaining-DSL" class="headerlink" title="Chaining DSL"></a>Chaining DSL</h2><p>We can work around the recursion problem by nudging compiler to do more diligent work. Because every method/function call return a new type symbol, we can use it to escape from recursion trap:</p>
<p>Definition:<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">class</span> VueTyped&lt;T&gt; &#123;</div><div class="line">  data&lt;D&gt;(d: D): VueTyped&lt;T &amp; D&gt;</div><div class="line">  method&lt;M extends &#123;[k:<span class="built_in">string</span>]: (<span class="keyword">this</span>: T) =&gt; <span class="built_in">any</span>&#125;&gt;(m: M): VueTyped&lt;T &amp; M&gt;</div><div class="line">  <span class="keyword">get</span>(): T</div><div class="line">  <span class="keyword">static</span> <span class="keyword">new</span>(): VueTyped&lt;&#123;&#125;&gt;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Usage:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">VueTyped.new()</div><div class="line">  .data(&#123;msg: <span class="string">'hehehe'</span>&#125;)</div><div class="line">   <span class="comment">// return a new type symbol with field `msg`</span></div><div class="line">  .method(&#123;method() &#123;<span class="keyword">return</span> <span class="string">'hello: '</span> + <span class="keyword">this</span>.msg&#125;&#125;)</div><div class="line">  <span class="comment">// create a new type symbol with `msg` and `method`</span></div><div class="line">  .get() <span class="comment">// type as &#123;msg: string, method(): string&#125;</span></div></pre></td></tr></table></figure>
<p> Quick explanation. <code>data</code> has a signature like <code>data&lt;D&gt;(d: D): VueTyped&lt;D &amp; T&gt;</code>. The intersection type in return position mocks <code>mixin</code> behavior. <code>method&lt;M extends {[k:string]: (this: T) =&gt; any}&gt;(m: M): VueTyped&lt;T &amp; M&gt;</code> is more complicated. Parameter <code>M</code> is required for compiler to garner properties of option passed to <code>method</code> call. <code>M</code> is bounded by a constraint that every function in <code>option</code> must have <code>this</code> typed as the object we defined previously and that only defined property can be accessed via <code>this</code>. The final returning intersection type acts the same as <code>data</code>.</p>
<blockquote>
<p>Note: <code>method</code> does not work for current TypeScript. Probably it is a <a href="https://github.com/Microsoft/TypeScript/issues/10461" target="_blank" rel="external">bug</a></p>
</blockquote>
<p> But step-wise inference still cannot resolve <code>watch</code> and <code>computed</code> property. <code>$Keys</code> magic type or <code>keysof</code> type does not exist in TS yet! Meanwhile, flowtype does not support <code>this</code>-typed function.</p>
<p><code>computed</code> option is even harder to handle. There is no way to define <code>this</code> type in a getter/setter method. If we do not pass a getter/setter but a plain function as value, we cannot merge the computed properties into the resulting object.</p>
<p>A verbose workaround is <a href="http://blog.thoughtram.io/angular/2015/09/03/forward-references-in-angular-2.html" target="_blank" rel="external">forward reference</a> in type annotation:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = VueTyped.new()</div><div class="line">  .data(&#123; msg: <span class="string">'hehe'</span> &#125;)</div><div class="line">  .computed(&#123;</div><div class="line">    <span class="keyword">get</span> computed(<span class="keyword">this</span>: <span class="keyword">typeof</span> a) &#123; <span class="comment">// forward reference</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.msg + <span class="string">' from WET computed!'</span></div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">  .get()</div></pre></td></tr></table></figure>
<p>It’s not <em>DRY</em>.</p>
<p>Furthermore, this approach does not support language service feature like “looking for definition” or “finding all usage” because intersection type needs casting in implementation to work.</p>
<blockquote>
<p><strong>Irreparable! Irredeemable! Irremediable!</strong></p>
</blockquote>
<p>However, this approach has some benefits. First, it is easier to extend its functionality. If one would like to add <code>vuex</code> field in option, it just requires defining a new method. It also prevents cyclic dependency because you cannot use fields before declaring. The API itself is akin to its original version, and thusly the implementation is very thin.</p>
<h2 id="Class-Decorator"><a href="#Class-Decorator" class="headerlink" title="Class Decorator"></a>Class Decorator</h2><p>This approach is much more conventional, and is discussed broadly in Vue’s <a href="https://github.com/vuejs/vue/issues/478" target="_blank" rel="external">issue</a>.</p>
<p>The basic idea is to define as many methods as possible in a class and to decorate fields to add Vue specific logic.</p>
<p>One exceptional API is provided by <a href="https://github.com/vuejs/vue/issues/478" target="_blank" rel="external">itsFrank’s vue-typescript</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * as Vue from <span class="string">'vue'</span></div><div class="line"><span class="keyword">import</span> &#123; VueComponent, Prop &#125; from <span class="string">'vue-typescript'</span></div><div class="line"></div><div class="line"><span class="meta">@VueComponent</span></div><div class="line"><span class="keyword">class</span> MyComponent &#123;</div><div class="line">    <span class="meta">@Prop</span> someProp:<span class="built_in">string</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Prop</span>(&#123;</div><div class="line">        <span class="keyword">type</span>: <span class="built_in">String</span></div><div class="line">    &#125;)</div><div class="line">    someDefaultProp:<span class="built_in">string</span> = <span class="string">'some default value'</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Prop</span> someObjProp:&#123;some_default:<span class="built_in">string</span>&#125; = &#123;some_default: <span class="string">'value'</span>&#125;; <span class="comment">//vue-typescript makes sure to deep clone default values for array and object types</span></div><div class="line"></div><div class="line">    <span class="meta">@Prop</span> someFuncProp()&#123; <span class="comment">//defined functions decorated with prop are treated as the default value</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'logged from default function!'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    someVar:<span class="built_in">string</span> = <span class="string">'Hello!'</span>;</div><div class="line"></div><div class="line">    doStuff() &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'I did stuff'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This TSish approach enables more capability of compiler tooling such as usage finding and definition lookup. Class decorator also guarantees every method’s <code>this</code> correctly points to class instance, which cannot be achieved in <strong>Chaining DSL</strong> approach.</p>
<p>With higher abstraction comes more confusion. Indeed, class decorator smooths out the discrepancy between Vue and type checker. But syntactically its API is much further from Vue’s original one. Adding new API is also harder because every decorator is <a href="https://github.com/itsFrank/vue-typescript/blob/master/src/vuecomponent.ts#L31" target="_blank" rel="external">hard coded</a> in <code>VueComponent</code> decorator’s code. For example, adding <code>@vuex</code> is almost impossible without rolling out a new <code>VuexComponent</code>. It also cannot transform all Vue’s API, such as <code>watch</code> and <a href="https://vuejs.org/guide/reactivity.html#Inside-Computed-Properties" target="_blank" rel="external"><code>computed: { cache: false }</code></a>, into idiomatic TypeScript, leaving some orifices in type safety.</p>
<p><del>I have an alternative API bike shedding but not ready to present. Maybe I will try it later.</del></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>This article presents type-safety problem in Vue and two ways to mitigate the problem. Rewritten in ES015 and type-checked by one of the most advanced type checkers, Vue is designed in ES5 era and, satirically, is still <a href="https://github.com/vuejs/vue/issues/478#issuecomment-129498731" target="_blank" rel="external">designed for</a> ES5 code.</p>
<p>Vue doesn’t come with type safety in mind. But this is might be a mirroring of some part in the community where some developers have almost kind of <em>Stockholm Syndrome</em>: they encounter so many type unsafe ordeals that they are very happy and proud with their lavish use of reflection which backfires to themselves.</p>
<p>Yet one should always keep a leery eye a <code>Static Typist</code>‘s maniacal malarkey. Static typing system works the same way as <strong>BDSM</strong>: the more constraints, the more pleasure. Once having tasted the relish of bondage, a bottom will avariciously demand more complex tricks and more powerful constraints from typing system. That urge is so strong that the bottom loses incentives to lumber out of <em>the fifty shades of types</em>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/07/how-to-config-node-cdn/" itemprop="url">
                  A collection of nodejs CDN for Celestial Imperial
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-07T00:00:00+08:00" content="2016-06-07">
              2016-06-07
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/07/how-to-config-node-cdn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/06/07/how-to-config-node-cdn/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Living inside of the Great Fire Wall is a so onerous ordeal that survival guides can be compiled into an anthology.</p>
<p>Here is how to configure various popular open source project to use their CDN in Ch<strong>**</strong>na.</p>
<p>Plenty of nodejs project provide environment variable to configure mirror/CDN to download source code or binary.</p>
<h2 id="nvm-nodejs"><a href="#nvm-nodejs" class="headerlink" title="nvm / nodejs"></a>nvm / nodejs</h2><p><a href="https://cnodejs.org/topic/5338c5db7cbade005b023c98" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NVM_NODEJS_ORG_MIRROR=https://npm.taobao.org/mirrors/node nvm install 4</div></pre></td></tr></table></figure>
<h2 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h2><p><a href="https://cnodejs.org/topic/5338c5db7cbade005b023c98" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm --registry=https://registry.npm.taobao.org install koa</div></pre></td></tr></table></figure>
<p>Kudos to <a href="https://cnodejs.org/user/fengmk2" target="_blank" rel="external">fengmk2</a></p>
<h2 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h2><p><a href="https://cnodejs.org/topic/538ed941c3ee0b5820889f66" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PHANTOMJS_CDNURL=https://npm.taobao.org/dist/phantomjs npm install phantomjs --registry=https://registry.npm.taobao.org --no-proxy</div></pre></td></tr></table></figure>
<p>Kudos to <a href="https://cnodejs.org/user/fengmk2" target="_blank" rel="external">fengmk2</a>, again!</p>
<h2 id="node-sass"><a href="#node-sass" class="headerlink" title="node-sass"></a>node-sass</h2><p><a href="https://github.com/cnpm/cnpm/pull/76/files" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SASS_BINARY_SITE=https://registry.npmjs.org/node-sass npm install node-sass</div></pre></td></tr></table></figure>
<p>Kudos, again and again, to fengmk2</p>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p><a href="http://www.imike.me/2016/04/20/Docker%E4%B8%8B%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F/" target="_blank" rel="external">Ref</a></p>
<p>Install Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl <span class="_">-s</span>SL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -</div></pre></td></tr></table></figure>
<p>Config accelerator</p>
<p>You need to register an account in <a href="http://xxxxxx.m.daocloud.io" target="_blank" rel="external">daocloud.io</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"DOCKER_OPTS=\"--registry-mirror=http://xxxxxx.m.daocloud.io\""</span> | sudo tee <span class="_">-a</span> /etc/default/docker</div><div class="line">sudo service docker restart</div></pre></td></tr></table></figure>
<p>Kudos to daocloud.</p>
<h2 id="Pypi"><a href="#Pypi" class="headerlink" title="Pypi"></a>Pypi</h2><p><a href="http://www.cnblogs.com/meelo/p/4636340.html" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat &lt;~/.pip/pip.conf &lt;&lt;EOF</div><div class="line">[global]</div><div class="line">index-url = http://mirrors.aliyun.com/pypi/simple/</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>Kudos to aliyun</p>
<h2 id="sbt"><a href="#sbt" class="headerlink" title="sbt"></a>sbt</h2><p><a href="http://freewind.in/posts/2619-sbt-global-repo/" target="_blank" rel="external">Ref</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &gt; ~/.sbt/repositories &lt;&lt;EOF</div><div class="line">[repositories]</div><div class="line"><span class="built_in">local</span></div><div class="line">osc: http://maven.oschina.net/content/groups/public/</div><div class="line">typesafe: http://repo.typesafe.com/typesafe/ivy-releases/, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[<span class="built_in">type</span>]s/[artifact](-[classifier]).[ext], bootOnly</div><div class="line">sonatype-oss-releases</div><div class="line">maven-central</div><div class="line">sonatype-oss-snapshots</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>Kudos to <a href="http://freewind.in/" target="_blank" rel="external">freewind</a></p>
<p>And these links is useful:<br><a href="https://segmentfault.com/a/1190000002474507" target="_blank" rel="external">加速 SBT 下载依赖库的速度</a><br><a href="http://afoo.me/posts/2014-11-05-how-make-sbt-jump-over-GFW.html" target="_blank" rel="external">how to make sbt jump over GFW</a></p>
<h2 id="Gopm"><a href="#Gopm" class="headerlink" title="Gopm"></a>Gopm</h2><p><a href="https://github.com/gpmgo/gopm" target="_blank" rel="external">Ref</a></p>
<p>It is quite clear in the doc and help command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">gopm get &lt;import path&gt;@[&lt;tag|commit|branch&gt;:&lt;value&gt;]</div><div class="line">gopm get &lt;package name&gt;@[&lt;tag|commit|branch&gt;:&lt;value&gt;]</div><div class="line"></div><div class="line">useful options:</div><div class="line">   --update, -u		update package(s) and dependencies <span class="keyword">if</span> any</div><div class="line">   --gopath, -g		download all packages to GOPATH</div></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Hail Aliyun! Hail fengmk2!<br>For the unfortunate who live in a crappy ignorant country.</p>
<img src="/images/Hatsune.Miku.full.2006986.jpg">

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/26/dein/" itemprop="url">
                  Trying out dein.vim -- a dark powered plugin manager
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-02-26T00:00:00+08:00" content="2016-02-26">
              2016-02-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/26/dein/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/02/26/dein/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Dark-Powered-Plugin"><a href="#Dark-Powered-Plugin" class="headerlink" title="Dark Powered Plugin"></a>Dark Powered Plugin</h2><p><a href="http://qiita.com/yoza/items/2f8bd33a18225754f346" target="_blank" rel="external">Original Japanese post here</a></p>
<p>Vim already has a lot of plugin managers.<br>But our <a href="https://twitter.com/ShougoMatsu" target="_blank" rel="external">Dark Vim Master</a> has released neobundle’s successor, a brand-new plugin manger called <a href="https://github.com/Shougo/dein.vim" target="_blank" rel="external">dein.vim</a>.</p>
<blockquote>
<p>Dein.vim is a dark powered Vim/NeoVim plugin manager.</p>
</blockquote>
<p>To put it in plain English, dein.vim is a plugin manager focusing on both <strong>installation performance</strong> and <strong>startup performance</strong>.<br>It looks like a neobunle with vim-plug’s speed, or a vim-plug with neobunle’s feature. The best of both worlds.</p>
<p>In this blog post I will first show minimal configuration for dein.vim, and then try to explain the dark power of dein, if you are interested in what makes dein.vim so fast.</p>
<h2 id="Minimal-Configuration"><a href="#Minimal-Configuration" class="headerlink" title="Minimal Configuration"></a>Minimal Configuration</h2><blockquote>
<p>Though dark powered, dein.vim supports vim and neovim.</p>
</blockquote>
<p>Sadly, there is no installation script for dein.vim for now.<br>So let’s manually install it.</p>
<p>First, clone dein.vim’s source.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir -p ~/.vim/dein/repos/github.com/Shougo/dein.vim <span class="comment">#recommended path</span></div><div class="line">git <span class="built_in">clone</span> https://github.com/Shougo/dein.vim.git \</div><div class="line">    ~/.vim/dein/repos/github.com/Shougo/dein.vim</div></pre></td></tr></table></figure>
<p>If you are familiar with neobundle/vundle, you will find dein.vim’s path so different. It is because dein uses a new approach to manage plugin’s source.</p>
<p>Optionally, you can backup your vimrc for profiling, as I will show later.</p>
<p>Then, in your <code>init.vim</code> or <code>.vimrc</code>.<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> nocompatible</div><div class="line"><span class="keyword">set</span> runtimepath+=~/.<span class="keyword">vim</span>/dein/repos/github.<span class="keyword">com</span>/Shougo/dein.<span class="keyword">vim</span> <span class="comment">" path to dein.vim</span></div><div class="line"></div><div class="line"><span class="keyword">call</span> dein#begin(<span class="built_in">expand</span>(<span class="string">'~/.vim/dein'</span>)) <span class="comment">" plugins' root path</span></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'Shougo/dein.vim'</span>)</div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'Shougo/vimproc.vim'</span>, &#123;</div><div class="line">    \ <span class="string">'build'</span>: &#123;</div><div class="line">    \     <span class="string">'windows'</span>: <span class="string">'tools\\update-dll-mingw'</span>,</div><div class="line">    \     <span class="string">'cygwin'</span>: <span class="string">'make -f make_cygwin.mak'</span>,</div><div class="line">    \     <span class="string">'mac'</span>: <span class="string">'make -f make_mac.mak'</span>,</div><div class="line">    \     <span class="string">'linux'</span>: <span class="string">'make'</span>,</div><div class="line">    \     <span class="string">'unix'</span>: <span class="string">'gmake'</span>,</div><div class="line">    \    &#125;,</div><div class="line">    \ &#125;)</div><div class="line"></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'Shougo/unite.vim'</span>)</div><div class="line"></div><div class="line"><span class="comment">" and a lot more plugins.....</span></div><div class="line"></div><div class="line"><span class="keyword">call</span> dein#end()</div></pre></td></tr></table></figure></p>
<p>Fire up your neovim/vim, call dein.vim’s installation function</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:<span class="keyword">call</span> dein#install()</div></pre></td></tr></table></figure>
<p>Wait and brew yourself a cup of (instant) coffee.<br>Then you can confirm your installation, for example call <code>:Unite dein</code></p>
<h2 id="More-features"><a href="#More-features" class="headerlink" title="More features"></a>More features</h2><p>The most important feature of dein.vim is lazy load. Here are some typical usages worth mentioning.</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">" lazy load on filetype</span></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'justmao945/vim-clang'</span>,</div><div class="line">      \&#123;<span class="string">'on_ft'</span>: [<span class="string">'c'</span>, <span class="string">'cpp'</span>]&#125;)</div><div class="line"></div><div class="line"><span class="comment">" lazy load on command executed</span></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'scrooloose/nerdtree'</span>,</div><div class="line">      \&#123;<span class="string">'on_cmd'</span>: <span class="string">'NERDTreeToggle'</span>&#125;)</div><div class="line"></div><div class="line"><span class="comment">" lazy load on insert mode</span></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'Shougo/deoplete.nvim'</span>,</div><div class="line">      \&#123;<span class="string">'on_i'</span>: <span class="number">1</span>&#125;)</div><div class="line"></div><div class="line"><span class="comment">" lazy load on function call</span></div><div class="line"><span class="keyword">call</span> dein#add(<span class="string">'othree/eregex.vim'</span>,</div><div class="line">      \&#123;<span class="string">'on_func'</span>: <span class="string">'eregex#toggle'</span>&#125;)</div></pre></td></tr></table></figure>
<p>The last two lazy loading conditions are not available in Vimplug. While lazy loading according to mode change is very convenient.</p>
<h2 id="Two-Tales-of-Plugin-Manager"><a href="#Two-Tales-of-Plugin-Manager" class="headerlink" title="Two Tales of Plugin Manager"></a>Two Tales of Plugin Manager</h2><p>From here on I will talk about dein’s internal feature. It’s my personal observation, please pardon my mistake and misunderstanding.</p>
<p>Vim’s plugin managers have to take two aspects into consideration: installation time and startup time.<br>You can read <a href="https://github.com/junegunn/" target="_blank" rel="external">junegunn</a>‘s blogs article, <a href="http://junegunn.kr/2013/09/writing-my-own-vim-plugin-manager/" target="_blank" rel="external">this</a> and <a href="http://junegunn.kr/2014/07/vim-plugins-and-startup-time/" target="_blank" rel="external">this</a>, for more details on plugin manager.</p>
<blockquote>
<p>dein.vim is fast because it uses dark power</p>
</blockquote>
<p><a href="http://www.urbandictionary.com/define.php?term=jkjk" target="_blank" rel="external">JK</a><a href="https://en.wikipedia.org/wiki/JK" target="_blank" rel="external">JK</a>. Actually, dein.vim optimizes both two performance, by following measures:</p>
<ol>
<li><p><strong>parallel installation</strong> dein.vim uses either <a href="http://exhentai.org/s/56aedaf7ad/908231-9" target="_blank" rel="external">vimproc</a> or neovim’s <a href="https://neovim.io/doc/user/job_control.html" target="_blank" rel="external">async job</a> to download plugins concurrently.</p>
</li>
<li><p><strong>precomputed runtimepath</strong> dein.vim will copy all plugins’ subdirectory into a cache directory. This merges all runtime VimScript files into one directory. So dein doesn’t need to compute runtimepath on startup.</p>
</li>
</ol>
<p>Dein.vim also ditches command usage in favor of function calling, which may also contribute to performance(I’m not sure, though).</p>
<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><p>Because dein.vim uses parallel processing, when errors occur in installation it may be hard to figure out which plugin went wrong. Usually you can see the error messages by <code>:message</code> after all plugin finished fetching (regardless of success or not). Or you can use <code>dein#check_install</code> function.</p>
<p>Also, precomputed cache makes modifying plugin harder. You will need to call <code>dein#recache_runtimepath()</code> after modification. This also applies to disabling plugins.</p>
<p>Lastly, if you happen to live in a country with stupid censorship which prevents github access. You will need a proxy and set <code>g:dein$install_process_timeout</code> to a larger value.</p>
<p>For more info please refer to <a href="https://github.com/Shougo/dein.vim/blob/master/doc/dein.txt" target="_blank" rel="external">doc</a>.</p>
<h2 id="Profiling-dein’s-power"><a href="#Profiling-dein’s-power" class="headerlink" title="Profiling dein’s power"></a>Profiling dein’s power</h2><p>Profiling vim’s startup time has a rather <a href="http://usevim.com/2012/04/18/startuptime/" target="_blank" rel="external">standard method</a>. You can try it by backup old vimrc and compare it to dein.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nvim -u old-init.vim --startuptime neobundle.log <span class="comment"># or change nvim to vim</span></div><div class="line">nvim -u new-init.vim --startuptime dein.log</div></pre></td></tr></table></figure>
<p>From the log, I can see dein.vim gives me 20ms startup boost! Mainly from boosting <code>sourcing vimrc</code>. Amazing!</p>
<p>If you use a lot of plugins, dein is definitely a must-try!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/01/typesafe-di/" itemprop="url">
                  TypeSafe DI in TypeScript
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-02-01T19:26:14+08:00" content="2016-02-01">
              2016-02-01
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/01/typesafe-di/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/02/01/typesafe-di/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <img src="/images/miku805.jpg">
<blockquote>
<p>Yet Another Type Level Arithmetics</p>
</blockquote>
<p>DI is getting more popularity in JavaScript. Though, those solution is far way beyond JSR-330 compatible libraries in terms of type safety and performance.</p>
<p>This snippet strives to dig more type-safety from TS’ type system. However, it can hardly achieve equivalent type safety like Java’s counterpart, e.g., Dagger, Guice.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><a href="https://gist.github.com/HerringtonDarkholme/f11152e6e29145040fa4" target="_blank" rel="external">This DI</a> snippet can, ideally, ensure every binding is resolved in compile time, which is a hard task for other DI solution. The main idea is an <code>Injector</code> can statically know its current binding, and judge whether dependencies of a new added binding can be already resolved by itself. Since dependency graph is a DAG, there exists a topological sorting order that every binding’s dependency can be resolved solely by those of preceding bindings . So once the injector is created and bindings are attached to it, we can assert that the dependencies can be resolved.</p>
<p>Say, there is a minimal example to illustrate this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line"><span class="keyword">class</span> Clerk &#123;&#125;</div><div class="line"><span class="meta">@Inject</span></div><div class="line"><span class="keyword">class</span> Shop &#123;<span class="keyword">constructor</span>(<span class="params">c: Clerk</span>)&#125;</div><div class="line">var inj = Injector.create(<span class="params"></span>)</div><div class="line">  .bind(<span class="params">Shop</span>).toClass(<span class="params">Shop</span>) // compile error here, injector cannot resolve Clerk</div><div class="line"></div><div class="line">var inj = Injector.create(<span class="params"></span>)</div><div class="line">  .bind(<span class="params">Clerk</span>).toClass(<span class="params">Clerk</span>)</div><div class="line">  .bind(<span class="params">Shop</span>).toClass(<span class="params">Shop</span>) // compiles. Clerk resolved before Shop</div></pre></td></tr></table></figure>
<p>To implement this, Injector has a shadow type <code>Base</code> that indicates resolved bindings. When new binding is added to injector, compiler will verify the new coming constructor/function will only depend on classes the injector has already resolved. Concretely, every argument in newly added constructor must be a subtype of <code>Base</code>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ctor = <span class="keyword">new</span> (...args: Base[]): T</div><div class="line"></div><div class="line">injector&lt;Base&gt;</div><div class="line">  .bind(NewClass)</div><div class="line">  .toClass(NewClass as Ctor)</div><div class="line"><span class="comment">/*</span></div><div class="line">Make sure here `toClass` is defined like</div><div class="line">type toClass = (Ctor) =&gt; Injector&lt;Base | T&gt;</div><div class="line">the union type indicates resolved type, and `T extends Base|T` holds valid</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><code>Base</code> is a large union type storing all binding types, so every resolved type is a subtype of <code>Base</code>. And <code>bind</code> will return a <code>binder</code> that has <code>toClass / toFactory</code> method which further returns an injector whose resolved binding is a union of the previous binding type and the newly added binding type. Hence, after <code>bind ... toClass</code>, the injector has a new class appended to its resolved type list.</p>
<p>The implementation and test can be found at <a href="https://gist.github.com/HerringtonDarkholme/f11152e6e29145040fa4" target="_blank" rel="external">Github Gist</a>.</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>But TS’ type system does not allow a full-fledged DI in this way.</p>
<ol>
<li><p>First, runtime types are erased. One must annotate dependency for function in <code>toFactory</code> method. <code>toClass</code> is better because TS supports <code>emitDecoratorMetadata</code>. (maybe resolved in TS2.0). TS’ specific metadata implementation is also problematic. For cyclic dependent classes, at least one class’ annotation is <code>undefined</code>(ES3/5), or the script is crashed before it can run (ES6). Because metadata is attached to class declaration, in cyclic case there must be one class is used before it’s declared.</p>
</li>
<li><p>TypeScript has a double-edged sutructural type system. To fully exploit DI’s type check, user has to add a <code>private</code> <code>brand</code> field to every injectable class. This is not a good UI, though.</p>
</li>
<li><p>But even metadata is not enough. Runtime type data is first-order (in type-system’s view), that is, every type is represented by its constructor, no generic information is emitted. To work around this, token is introduced.</p>
</li>
</ol>
<p>Token alleviates runtime type-system’s weakness, and enables binding multiple implementations to one single type. It also introduces more problem this DI wants to resolve in the first place. To work around point 1, we attached runtime types to constructor. Binding token will make type system think a type has resolved, but a following binding may not resolve it in runtime because it depends on constructor to find resolution.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">injector</div><div class="line">  .bind(clerkToken).toClass(Clerk)</div><div class="line">  .bind(Shop).toClass(Shop) <span class="comment">// compiles. but runtime error</span></div><div class="line"><span class="comment">// toClass will analyze Shop's signature and extract the Clerk constructor</span></div><div class="line"><span class="comment">// it can be found in type-level because Token&lt;Clerk&gt; enable injector to resolve Clerk, but at runtime injector can only resolve clerkToken, not Clerk</span></div></pre></td></tr></table></figure>
<p>Also, tokens with same types cannot avoid this.</p>
<p>The workaround is, well, abusing string literal type. So every token is different at type-level. This requires users to type more types, and casts string literal from string type to string literal type. (TS’s generic inference does not have something like <code>T extends StringLiteral</code> so that <code>T</code> is inferred as string literal type)</p>
<p>Also, the <code>toClass</code> and <code>toFactory</code> signature should differentiate what can be resolved by constructor and by token.  This is technically possible, just override these signature to support distinguishing between token and constructor. But the number of resulting overriding is exponential to the number of argument. 2 ^ n, where n is the number of arguments.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>To fully support type-safe DI and higher performance, a compiler extension or a code generator is needed. Java’s DI relies on annotations and code generation.</p>
<p>Maybe Babel can do this right now. But TypeScript still needs a long way to go for a customizable emitter.</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">'reflect-metadata'</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> _ = &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> ClassN&lt;N, T&gt; = &#123; <span class="keyword">new</span> (...a: N[]): T &#125;</div><div class="line"><span class="keyword">type</span> FN8&lt;A, B, C, D, E, F, G, H, R&gt; = (a?: A, b?: B, c?: C, d?: D, e?: E, f?: F, g?: G, h?: H) =&gt; R</div><div class="line"><span class="keyword">type</span> CLS8&lt;A, B, C, D, E, F, G, H, R&gt; = &#123; <span class="keyword">new</span> (a?: A, b?: B, c?: C, d?: D, e?: E, f?: F, g?: G, h?: H): R&#125;</div><div class="line"></div><div class="line"><span class="keyword">class</span> Token&lt;T&gt; &#123;</div><div class="line">  <span class="keyword">private</span> _tokenBrand</div><div class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> name: <span class="built_in">string</span></span>) &#123;&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Bindable&lt;T&gt; = Token&lt;T&gt; | ClassN&lt;_, T&gt;</div><div class="line"></div><div class="line"><span class="keyword">const</span> PARAMTYPE = <span class="string">'design:paramtypes'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSignature</span>&lt;<span class="title">T</span>&gt;(<span class="params">cls: ClassN&lt;T, _&gt;</span>): <span class="title">Array</span>&lt;<span class="title">Bindable</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123; <span class="keyword">return</span> Reflect.getOwnMetadata(PARAMTYPE, cls).slice() || [] &#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">enum</span> BindType &#123; CLASS, VALUE, FACTORY &#125;</div><div class="line"><span class="keyword">class</span> Binder&lt;T, Base&gt; &#123;</div><div class="line">  dependencies: Bindable&lt;Base&gt;[] = []</div><div class="line">  cacheable: <span class="built_in">boolean</span> = <span class="literal">false</span></div><div class="line">  <span class="keyword">private</span> _type: BindType</div><div class="line">  <span class="keyword">private</span> _cls: ClassN&lt;<span class="built_in">any</span>, T&gt; = <span class="literal">null</span></div><div class="line">  <span class="keyword">private</span> _val: T</div><div class="line">  <span class="keyword">private</span> _fn: <span class="built_in">Function</span></div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> _injector: Injector&lt;Base&gt;</span>) &#123;&#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> _releaseInjector() &#123;</div><div class="line">    <span class="keyword">let</span> injector = <span class="keyword">this</span>._injector</div><div class="line">    <span class="keyword">this</span>._injector = <span class="literal">null</span></div><div class="line">    <span class="keyword">return</span> injector</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  toClass&lt;A extends Base, B extends Base, C extends Base, D extends Base, E extends Base, F extends Base, G extends Base, H extends Base&gt;(fn: CLS8&lt;A, B, C,  D, E, F, G, H, T&gt;, a?: Bindable&lt;A&gt;, b?: Bindable&lt;B&gt;, c?: Bindable&lt;C&gt;, d?: Bindable&lt;D&gt;, e?: Bindable&lt;E&gt;, f?: Bindable&lt;F&gt;, g?: Bindable&lt;G&gt;, h?: Bindable&lt;H&gt;): Injector&lt;Base | T&gt;</div><div class="line">  toClass(cls: ClassN&lt;Base, T&gt;, ...deps: Bindable&lt;Base&gt;[]): Injector&lt;Base | T&gt; &#123;</div><div class="line">    <span class="keyword">this</span>._type = BindType.CLASS</div><div class="line">    <span class="keyword">this</span>._cls = cls</div><div class="line">    <span class="keyword">this</span>.dependencies = getSignature(cls)</div><div class="line">    deps.forEach((d, i) =&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (d) <span class="keyword">this</span>.dependencies[i] = d</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._releaseInjector()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  toValue(val: T): Injector&lt;Base | T&gt; &#123;</div><div class="line">    <span class="keyword">this</span>._type = BindType.VALUE</div><div class="line">    <span class="keyword">this</span>._val = val</div><div class="line">    <span class="keyword">this</span>.cacheable = <span class="literal">true</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._releaseInjector()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  toFactory&lt;A extends Base, B extends Base, C extends Base, D extends Base, E extends Base, F extends Base, G extends Base, H extends Base&gt;(fn: FN8&lt;A, B, C,  D, E, F, G, H, T&gt;, a?: Bindable&lt;A&gt;, b?: Bindable&lt;B&gt;, c?: Bindable&lt;C&gt;, d?: Bindable&lt;D&gt;, e?: Bindable&lt;E&gt;, f?: Bindable&lt;F&gt;, g?: Bindable&lt;G&gt;, h?: Bindable&lt;H&gt;): Injector&lt;Base | T&gt;</div><div class="line">  toFactory(fn: (...a: Base[]) =&gt; T, ...deps: Bindable&lt;Base&gt;[]): Injector&lt;Base | T&gt; &#123;</div><div class="line">    <span class="keyword">this</span>._type = BindType.FACTORY</div><div class="line">    <span class="keyword">this</span>._fn = fn</div><div class="line">    <span class="keyword">this</span>.dependencies = deps</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._releaseInjector()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  resolve(deps: <span class="built_in">any</span>[]): Promise&lt;T&gt; &#123;</div><div class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>._type) &#123;</div><div class="line">      <span class="keyword">case</span> BindType.CLASS:</div><div class="line">        <span class="keyword">let</span> cls = <span class="keyword">this</span>._cls</div><div class="line">        <span class="keyword">return</span> Promise.resolve(<span class="keyword">new</span> cls(...deps))</div><div class="line">      <span class="keyword">case</span> BindType.VALUE:</div><div class="line">        <span class="keyword">return</span> Promise.resolve(<span class="keyword">this</span>._val)</div><div class="line">      <span class="keyword">case</span> BindType.FACTORY:</div><div class="line">        <span class="keyword">return</span> Promise.resolve(<span class="keyword">this</span>._fn(...deps))</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">class</span> Injector&lt;Base&gt; &#123;</div><div class="line">  <span class="keyword">private</span> _resolving = <span class="keyword">new</span> Set&lt;Bindable&lt;_&gt;&gt;()</div><div class="line">  <span class="keyword">private</span> _typeBinderMap = <span class="keyword">new</span> Map&lt;Bindable&lt;_&gt;, Binder&lt;_, Base&gt;&gt;()</div><div class="line">  <span class="keyword">private</span> _cache = <span class="keyword">new</span> Map&lt;Bindable&lt;_&gt;, Promise&lt;<span class="built_in">any</span>&gt;&gt;()</div><div class="line"></div><div class="line">  <span class="keyword">get</span>&lt;T extends Base&gt;(cls: Bindable&lt;T&gt;): Promise&lt;T&gt; &#123;</div><div class="line">    <span class="keyword">let</span> binder = <span class="keyword">this</span>._typeBinderMap.get(cls)</div><div class="line">    <span class="keyword">if</span> (!binder) <span class="keyword">throw</span> <span class="keyword">new</span> NoBinding(cls[<span class="string">'name'</span>])</div><div class="line"></div><div class="line">    <span class="keyword">let</span> cache = binder.cacheable ? <span class="keyword">this</span>._cache.get(cls) : <span class="literal">null</span></div><div class="line">    <span class="keyword">if</span> (cache) &#123;</div><div class="line">      <span class="keyword">return</span> cache</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._resolving.has(cls)) <span class="keyword">throw</span> <span class="keyword">new</span> CyclicDependency(cls[<span class="string">'name'</span>])</div><div class="line"></div><div class="line">    <span class="keyword">this</span>._resolving.add(cls)</div><div class="line">    <span class="keyword">let</span> depPromise = binder.dependencies.map(dep =&gt; <span class="keyword">this</span>.get(dep))</div><div class="line">    <span class="keyword">this</span>._resolving.delete(cls)</div><div class="line"></div><div class="line">    <span class="keyword">let</span> ret = Promise.all(depPromise).then(args =&gt; binder.resolve(args))</div><div class="line">    <span class="keyword">if</span> (binder.cacheable) <span class="keyword">this</span>._cache.set(cls, ret)</div><div class="line">    <span class="keyword">return</span> ret</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  bind&lt;T&gt;(cls: Bindable&lt;T&gt;): Binder&lt;T, Base&gt; &#123;</div><div class="line">    <span class="keyword">let</span> binder = <span class="keyword">new</span> Binder&lt;T, Base&gt;(<span class="keyword">this</span>)</div><div class="line">    <span class="keyword">this</span>._typeBinderMap.set(cls, binder)</div><div class="line">    <span class="keyword">return</span> binder</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> create(): Injector&lt;Injector&lt;_&gt;&gt; &#123;</div><div class="line">    <span class="keyword">let</span> inj = <span class="keyword">new</span> Injector&lt;Injector&lt;_&gt;&gt;()</div><div class="line">    inj.bind(Injector).toValue(inj)</div><div class="line">    <span class="keyword">return</span> inj</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/06/rplugin-notfound/" itemprop="url">
                  Trouble Shooting NeoVim's rplugin not found
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2015-12-06T00:00:00+08:00" content="2015-12-06">
              2015-12-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/12/06/rplugin-notfound/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/06/rplugin-notfound/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://geoff.greer.fm/2015/01/15/why-neovim-is-better-than-vim/" target="_blank" rel="external">NeoVim</a> is awesome. But after its 0.1 release, neovim is not that awesome, after all, in a old vimmer’s eye.</p>
<p>To support <a href="https://wiki.archlinux.org/index.php/Xdg-open" target="_blank" rel="external">XDG</a> configuration, NeoVim <a href="https://github.com/neovim/neovim/wiki/Following-HEAD#20151026" target="_blank" rel="external">changed default config paths</a>. After that patch, neovim search <code>~/.config/nvim/init.vim</code> rather than our old friend <code>~/.nvimrc</code>. So I changed my zshrc to alias <code>v</code> to <code>nvim -u ~/.nvimrc</code>. So I can use old configuration without relocating files.</p>
<p>It works fine, except <a href="https://github.com/Shougo/deoplete.nvim" target="_blank" rel="external">Deoplete</a> always complain about its remote plugin is not registered. When I execute <code>UpdateRemotePlugins</code> as Deoplete’s doc said, a new <code>.-rplugin-</code> file always spawn in my working directory. Without that weird file, Deoplete will never work.</p>
<p>I think this is configuration problem. But how can I figure out what happened? I start to resolving this by guess.</p>
<p><code>.-rplugin</code> is the critical file on which Deoplete depends. So NeoVim should search for it when booting. I searched for NeoVim’s repository for its usage. Yes, it does appear in neovim’s source, in <code>neovim/runtime/autoload/remote/host.vim</code>.</p>
<p>It reads:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let s:remote_plugins_manifest = fnamemodify(expand($MYVIMRC, 1), &apos;:h&apos;)</div><div class="line">      \.&apos;/.&apos;.fnamemodify($MYVIMRC, &apos;:t&apos;).&apos;-rplugin~&apos;</div></pre></td></tr></table></figure>
<p>Hmmm, NeoVim will find <code>.-rplugin</code> in the same directory of <code>$MYVIMRC</code>. But where does <code>$MYVIMRC</code> come from?</p>
<p>Searching neovim’s doc gives me the answer. In <a href="https://github.com/neovim/neovim/blob/84a5709a86cc8d2d90cc29eea26f254b9b5d85fa/runtime/doc/starting.txt#L394" target="_blank" rel="external"><code>:h starting</code></a>, it writes:</p>
<blockquote>
<p>If Vim was started with “-u filename”, the file “filename” is used.<br>  All following initializations until 4. are skipped. $MYVIMRC is not<br>  set.</p>
</blockquote>
<p>Oh, so I have to relocate my <code>vimrc</code> file. After that, every thing works :).</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Herrington Darkholme" />
          <p class="site-author-name" itemprop="name">Herrington Darkholme</p>
          <p class="site-description motion-element" itemprop="description">あくまでも紳士です</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">29</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Herrington Darkholme</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'herrington_darkholme';
      var disqus_identifier = 'index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  

  

  

</body>
</html>
